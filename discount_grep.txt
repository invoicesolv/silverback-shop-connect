./.env.production:3:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./.env.production:6:VITE_STRIPE_PUBLISHABLE_KEY=pk_live_51PDOJERwnR6blBksJj5d1YRS3qullycUda6G48z2ETGJvHd7AvOt061oFLkgWNo6g1c4uNZVOoU64MFDnOeKtjiK00QGDX8qy7
./.env.local:3:VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51RxmfY2KYnpDQ8IOWO0gcvEpdMV1PhiVW77btj56Bm1a9E2XWZkUGP1uOfZFcrFZlT94xoNbWctMuJdAP0J58IOR00clddWmZU
./.env.local:4:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
Binary file ./bun.lockb matches
./local-api-server.cjs:63:    const resendApiKey = process.env.VITE_RESEND_API_KEY;
./local-api-server.cjs:263:    console.log(`   RESEND_API_KEY: ${process.env.VITE_RESEND_API_KEY ? '✅ Set' : '❌ Missing'}`);
./ADMIN_SETUP.md:1:# Admin Discount Code Management System
./ADMIN_SETUP.md:3:This document explains how to set up and use the admin system for managing discount codes for both AlphaPrint and Silverback checkout.
./ADMIN_SETUP.md:26:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./ADMIN_SETUP.md:27:VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI
./ADMIN_SETUP.md:31:SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
./ADMIN_SETUP.md:85:- **Discount Code Management**: Create, edit, activate/deactivate, and delete codes
./ADMIN_SETUP.md:88:### Creating Discount Codes
./ADMIN_SETUP.md:96:   - **Value**: Discount value (10 for 10% or 20.00 for €20)
./ADMIN_SETUP.md:103:The system comes with these pre-configured discount codes:
./ADMIN_SETUP.md:117:- `GET /api/admin/discount-codes` - List all discount codes
./ADMIN_SETUP.md:118:- `POST /api/admin/discount-codes` - Create new discount code
./ADMIN_SETUP.md:119:- `PUT /api/admin/discount-codes/:id` - Update discount code
./ADMIN_SETUP.md:120:- `DELETE /api/admin/discount-codes/:id` - Delete discount code
./ADMIN_SETUP.md:121:- `GET /api/admin/discount-usage` - Usage analytics
./ADMIN_SETUP.md:125:- `POST /api/validate-discount` - Validate a discount code
./ADMIN_SETUP.md:126:- `POST /api/apply-discount` - Apply and record discount usage
./ADMIN_SETUP.md:132:You can validate discount codes from your checkout forms:
./ADMIN_SETUP.md:135:// Validate discount code
./ADMIN_SETUP.md:136:const response = await fetch('http://localhost:3002/api/validate-discount', {
./ADMIN_SETUP.md:151:  console.log('Discount applied:', result.validation);
./ADMIN_SETUP.md:152:  // Apply discount to order
./ADMIN_SETUP.md:161:// After successful payment, record the discount usage
./ADMIN_SETUP.md:162:await fetch('http://localhost:3002/api/apply-discount', {
./ADMIN_SETUP.md:171:    discountAmount: 20.00,
./ADMIN_SETUP.md:201:- `discount_codes` - Stores all discount codes
./ADMIN_SETUP.md:202:- `discount_code_usage` - Tracks usage for analytics
./ADMIN_SETUP.md:211:1. **"Authentication failed"** - Check that SUPABASE_SERVICE_ROLE_KEY is correct
./DISCOUNT_CODE_ANALYSIS.md:1:# 🎫 COMPLETE DISCOUNT CODE API ANALYSIS
./DISCOUNT_CODE_ANALYSIS.md:3:## **📁 ALL DISCOUNT-RELATED FILES:**
./DISCOUNT_CODE_ANALYSIS.md:7:supabase/migrations/20250829135300_create_discount_codes_table.sql
./DISCOUNT_CODE_ANALYSIS.md:14:api/admin/discount-codes.js - Serverless discount codes endpoint  
./DISCOUNT_CODE_ANALYSIS.md:15:api/validate-discount.js - Public discount validation endpoint
./DISCOUNT_CODE_ANALYSIS.md:16:api/orders.js - Order creation with discount support
./DISCOUNT_CODE_ANALYSIS.md:18:api/admin/dashboard-stats.js - Dashboard stats with discount metrics
./DISCOUNT_CODE_ANALYSIS.md:23:src/pages/AdminDashboard.tsx - Admin discount management interface
./DISCOUNT_CODE_ANALYSIS.md:24:src/pages/AlphaPrintStart.tsx - Discount application in print flow
./DISCOUNT_CODE_ANALYSIS.md:25:src/pages/AlphaPrintQuote.tsx - Quote with discount calculation
./DISCOUNT_CODE_ANALYSIS.md:26:src/services/orderService.ts - Order service with discount handling
./DISCOUNT_CODE_ANALYSIS.md:40:- `api/admin/discount-codes.js` (Vercel serverless function)
./DISCOUNT_CODE_ANALYSIS.md:46:curl -s "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*&limit=1"
./DISCOUNT_CODE_ANALYSIS.md:66:// Get all discount codes (admin only) - temporarily bypass auth for testing
./DISCOUNT_CODE_ANALYSIS.md:67:app.get('/api/admin/discount-codes', async (req, res) => {
./DISCOUNT_CODE_ANALYSIS.md:70:      .from('discount_codes')
./DISCOUNT_CODE_ANALYSIS.md:80:    console.error('Get discount codes error:', error);
./DISCOUNT_CODE_ANALYSIS.md:81:    res.status(500).json({ error: 'Failed to fetch discount codes' });
./DISCOUNT_CODE_ANALYSIS.md:88:const fetchDiscountCodes = async () => {
./DISCOUNT_CODE_ANALYSIS.md:99:    const codesUrl = getApiUrl('/api/admin/discount-codes');
./DISCOUNT_CODE_ANALYSIS.md:111:2. **discount_codes Table Missing/Inaccessible** - RLS policies blocking access
./DISCOUNT_CODE_ANALYSIS.md:120:CREATE TABLE IF NOT EXISTS discount_codes (
./DISCOUNT_CODE_ANALYSIS.md:125:  discount_type VARCHAR(20) CHECK (discount_type IN ('percentage', 'fixed_amount')) NOT NULL,
./DISCOUNT_CODE_ANALYSIS.md:126:  discount_value DECIMAL(10,2) NOT NULL,
./DISCOUNT_CODE_ANALYSIS.md:128:  maximum_discount_amount DECIMAL(10,2),
./DISCOUNT_CODE_ANALYSIS.md:140:ALTER TABLE discount_codes ENABLE ROW LEVEL SECURITY;
./DISCOUNT_CODE_ANALYSIS.md:143:CREATE POLICY "Admin can manage discount codes" ON discount_codes
./DISCOUNT_CODE_ANALYSIS.md:149:CREATE POLICY "Service role full access" ON discount_codes
./DISCOUNT_CODE_ANALYSIS.md:158:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./DISCOUNT_CODE_ANALYSIS.md:159:VITE_SUPABASE_ANON_KEY=<your_actual_anon_key>
./DISCOUNT_CODE_ANALYSIS.md:160:SUPABASE_SERVICE_ROLE_KEY=<your_actual_service_role_key>
./DISCOUNT_CODE_ANALYSIS.md:168:     "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*"
./DISCOUNT_CODE_ANALYSIS.md:175:curl http://localhost:3002/api/admin/discount-codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:1:-- Create discount_codes table for managing discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:2:CREATE TABLE public.discount_codes (
./supabase/migrations/20250829135300_create_discount_codes_table.sql:7:  discount_type TEXT NOT NULL CHECK (discount_type IN ('percentage', 'fixed_amount')),
./supabase/migrations/20250829135300_create_discount_codes_table.sql:8:  discount_value DECIMAL(10,2) NOT NULL CHECK (discount_value > 0),
./supabase/migrations/20250829135300_create_discount_codes_table.sql:10:  maximum_discount_amount DECIMAL(10,2) CHECK (maximum_discount_amount IS NULL OR maximum_discount_amount > 0),
./supabase/migrations/20250829135300_create_discount_codes_table.sql:25:CREATE INDEX idx_discount_codes_code ON public.discount_codes (code);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:26:CREATE INDEX idx_discount_codes_is_active ON public.discount_codes (is_active);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:27:CREATE INDEX idx_discount_codes_valid_dates ON public.discount_codes (valid_from, valid_until);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:28:CREATE INDEX idx_discount_codes_created_at ON public.discount_codes (created_at DESC);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:31:ALTER TABLE public.discount_codes ENABLE ROW LEVEL SECURITY;
./supabase/migrations/20250829135300_create_discount_codes_table.sql:33:-- RLS Policies for discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:34:-- Public can view active discount codes for validation
./supabase/migrations/20250829135300_create_discount_codes_table.sql:35:CREATE POLICY "Active discount codes are viewable by everyone" ON public.discount_codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:38:-- Admin can view all discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:39:CREATE POLICY "Admin can view all discount codes" ON public.discount_codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:48:-- Admin can insert discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:49:CREATE POLICY "Admin can insert discount codes" ON public.discount_codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:58:-- Admin can update discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:59:CREATE POLICY "Admin can update discount codes" ON public.discount_codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:68:-- Admin can delete discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:69:CREATE POLICY "Admin can delete discount codes" ON public.discount_codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:79:CREATE TRIGGER update_discount_codes_updated_at
./supabase/migrations/20250829135300_create_discount_codes_table.sql:80:  BEFORE UPDATE ON public.discount_codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:84:-- Insert some sample discount codes for testing (optional)
./supabase/migrations/20250829135300_create_discount_codes_table.sql:85:INSERT INTO public.discount_codes (code, name, description, discount_type, discount_value, minimum_order_amount, is_active) VALUES
./supabase/migrations/20250829135300_create_discount_codes_table.sql:90:-- Create function to validate and use discount codes
./supabase/migrations/20250829135300_create_discount_codes_table.sql:91:CREATE OR REPLACE FUNCTION validate_discount_code(
./supabase/migrations/20250829135300_create_discount_codes_table.sql:98:  discount_id UUID,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:102:  discount_type TEXT,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:103:  discount_value DECIMAL,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:104:  discount_amount DECIMAL,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:109:  v_discount public.discount_codes%ROWTYPE;
./supabase/migrations/20250829135300_create_discount_codes_table.sql:110:  v_discount_amount DECIMAL;
./supabase/migrations/20250829135300_create_discount_codes_table.sql:113:  -- Find the discount code
./supabase/migrations/20250829135300_create_discount_codes_table.sql:114:  SELECT * INTO v_discount 
./supabase/migrations/20250829135300_create_discount_codes_table.sql:115:  FROM public.discount_codes 
./supabase/migrations/20250829135300_create_discount_codes_table.sql:116:  WHERE UPPER(discount_codes.code) = UPPER(p_code)
./supabase/migrations/20250829135300_create_discount_codes_table.sql:121:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Invalid discount code';
./supabase/migrations/20250829135300_create_discount_codes_table.sql:126:  IF (v_discount.valid_from IS NOT NULL AND v_discount.valid_from > now()) OR
./supabase/migrations/20250829135300_create_discount_codes_table.sql:127:     (v_discount.valid_until IS NOT NULL AND v_discount.valid_until < now()) THEN
./supabase/migrations/20250829135300_create_discount_codes_table.sql:128:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Discount code has expired or is not yet valid';
./supabase/migrations/20250829135300_create_discount_codes_table.sql:133:  IF v_discount.usage_limit IS NOT NULL AND v_discount.used_count >= v_discount.usage_limit THEN
./supabase/migrations/20250829135300_create_discount_codes_table.sql:134:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Discount code usage limit exceeded';
./supabase/migrations/20250829135300_create_discount_codes_table.sql:139:  IF p_order_amount IS NOT NULL AND p_order_amount < v_discount.minimum_order_amount THEN
./supabase/migrations/20250829135300_create_discount_codes_table.sql:141:      format('Minimum order amount of €%.2f required', v_discount.minimum_order_amount);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:145:  -- Calculate discount amount
./supabase/migrations/20250829135300_create_discount_codes_table.sql:146:  IF v_discount.discount_type = 'percentage' THEN
./supabase/migrations/20250829135300_create_discount_codes_table.sql:147:    v_discount_amount := (p_order_amount * v_discount.discount_value / 100);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:148:    -- Apply maximum discount limit if set
./supabase/migrations/20250829135300_create_discount_codes_table.sql:149:    IF v_discount.maximum_discount_amount IS NOT NULL THEN
./supabase/migrations/20250829135300_create_discount_codes_table.sql:150:      v_discount_amount := LEAST(v_discount_amount, v_discount.maximum_discount_amount);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:153:    v_discount_amount := v_discount.discount_value;
./supabase/migrations/20250829135300_create_discount_codes_table.sql:157:  v_final_amount := GREATEST(0, COALESCE(p_order_amount, 0) - v_discount_amount);
./supabase/migrations/20250829135300_create_discount_codes_table.sql:159:  -- Return valid discount
./supabase/migrations/20250829135300_create_discount_codes_table.sql:162:    v_discount.id,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:163:    v_discount.code,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:164:    v_discount.name,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:165:    v_discount.description,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:166:    v_discount.discount_type,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:167:    v_discount.discount_value,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:168:    v_discount_amount,
./supabase/migrations/20250829135300_create_discount_codes_table.sql:175:CREATE OR REPLACE FUNCTION increment_discount_usage(p_discount_id UUID)
./supabase/migrations/20250829135300_create_discount_codes_table.sql:178:  UPDATE public.discount_codes 
./supabase/migrations/20250829135300_create_discount_codes_table.sql:181:  WHERE id = p_discount_id;
./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:6:ADD COLUMN discount_code TEXT,
./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:7:ADD COLUMN discount_amount DECIMAL(10,2) DEFAULT 0;
./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:12:-- Add index for discount code analytics
./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:13:CREATE INDEX idx_orders_discount_code ON public.orders (discount_code);
./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:54:  total_discounts DECIMAL
./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:75:    COALESCE(SUM(discount_amount), 0)::DECIMAL as total_discounts
./package-lock.json:2:  "name": "vite_react_shadcn_ts",
./package-lock.json:8:      "name": "vite_react_shadcn_ts",
./package.json:2:  "name": "vite_react_shadcn_ts",
./.env:2:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./.env:6:VITE_STRIPE_PUBLISHABLE_KEY=pk_live_51PDOJERwnR6blBksJj5d1YRS3qullycUda6G48z2ETGJvHd7AvOt061oFLkgWNo6g1c4uNZVOoU64MFDnOeKtjiK00QGDX8qy7
./.env:10:# VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51RxmfY2KYnpDQ8IOWO0gcvEpdMV1PhiVW77btj56Bm1a9E2XWZkUGP1uOfZFcrFZlT94xoNbWctMuJdAP0J58IOR00clddWmZU
./.env:14:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./.env:15:VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI
./.env:16:SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTM3MzEzNiwiZXhwIjoyMDcwOTQ5MTM2fQ.1aOdVqBHXMlGDlL1M4EtV_EkCa5i7PQ9m6B7IxoEPbE
./api/admin-server.cjs:10:const supabaseUrl = process.env.VITE_SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./api/admin-server.cjs:11:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./api/admin-server.cjs:14:  console.error('❌ SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./api/admin-server.cjs:15:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./api/admin-server.cjs:46:    const anonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./api/admin-server.cjs:107:// Get all discount codes (admin only) - temporarily bypass auth for testing
./api/admin-server.cjs:108:app.get('/api/admin/discount-codes', async (req, res) => {
./api/admin-server.cjs:111:      .from('discount_codes')
./api/admin-server.cjs:121:    console.error('Get discount codes error:', error);
./api/admin-server.cjs:122:    res.status(500).json({ error: 'Failed to fetch discount codes' });
./api/admin-server.cjs:126:// Create new discount code (admin only)
./api/admin-server.cjs:127:app.post('/api/admin/discount-codes', verifyAdmin, async (req, res) => {
./api/admin-server.cjs:133:      discount_type,
./api/admin-server.cjs:134:      discount_value,
./api/admin-server.cjs:136:      maximum_discount_amount,
./api/admin-server.cjs:144:    if (!code || !discount_type || !discount_value) {
./api/admin-server.cjs:146:        error: 'Code, discount_type, and discount_value are required' 
./api/admin-server.cjs:151:      .from('discount_codes')
./api/admin-server.cjs:156:        discount_type,
./api/admin-server.cjs:157:        discount_value,
./api/admin-server.cjs:159:        maximum_discount_amount,
./api/admin-server.cjs:171:        return res.status(400).json({ error: 'Discount code already exists' });
./api/admin-server.cjs:178:    console.error('Create discount code error:', error);
./api/admin-server.cjs:179:    res.status(500).json({ error: 'Failed to create discount code' });
./api/admin-server.cjs:183:// Update discount code (admin only)
./api/admin-server.cjs:184:app.put('/api/admin/discount-codes/:id', verifyAdmin, async (req, res) => {
./api/admin-server.cjs:195:      .from('discount_codes')
./api/admin-server.cjs:206:      return res.status(404).json({ error: 'Discount code not found' });
./api/admin-server.cjs:211:    console.error('Update discount code error:', error);
./api/admin-server.cjs:212:    res.status(500).json({ error: 'Failed to update discount code' });
./api/admin-server.cjs:216:// Delete discount code (admin only)
./api/admin-server.cjs:217:app.delete('/api/admin/discount-codes/:id', verifyAdmin, async (req, res) => {
./api/admin-server.cjs:222:      .from('discount_codes')
./api/admin-server.cjs:233:      return res.status(404).json({ error: 'Discount code not found' });
./api/admin-server.cjs:236:    res.json({ success: true, message: 'Discount code deleted successfully' });
./api/admin-server.cjs:238:    console.error('Delete discount code error:', error);
./api/admin-server.cjs:239:    res.status(500).json({ error: 'Failed to delete discount code' });
./api/admin-server.cjs:243:// Get discount code usage analytics (admin only)
./api/admin-server.cjs:244:app.get('/api/admin/discount-usage/:codeId', verifyAdmin, async (req, res) => {
./api/admin-server.cjs:249:      .from('discount_code_usage')
./api/admin-server.cjs:252:        discount_codes (
./api/admin-server.cjs:255:          discount_type,
./api/admin-server.cjs:256:          discount_value
./api/admin-server.cjs:262:      query = query.eq('discount_code_id', codeId);
./api/admin-server.cjs:278:// Get all discount code usage analytics (admin only)
./api/admin-server.cjs:279:app.get('/api/admin/discount-usage', verifyAdmin, async (req, res) => {
./api/admin-server.cjs:284:      .from('discount_code_usage')
./api/admin-server.cjs:287:        discount_codes (
./api/admin-server.cjs:290:          discount_type,
./api/admin-server.cjs:291:          discount_value
./api/admin-server.cjs:297:      query = query.eq('discount_code_id', codeId);
./api/admin-server.cjs:313:// Public endpoint to validate discount codes (for frontend checkout)
./api/admin-server.cjs:314:app.post('/api/validate-discount', async (req, res) => {
./api/admin-server.cjs:323:      .rpc('validate_discount_code', {
./api/admin-server.cjs:335:    console.error('Validate discount error:', error);
./api/admin-server.cjs:336:    res.status(500).json({ error: 'Failed to validate discount code' });
./api/admin-server.cjs:340:// Apply discount code (record usage)
./api/admin-server.cjs:341:app.post('/api/apply-discount', async (req, res) => {
./api/admin-server.cjs:343:    const { code, orderId, customerEmail, discountAmount, orderAmount, ipAddress, userAgent } = req.body;
./api/admin-server.cjs:345:    // First get the discount code ID
./api/admin-server.cjs:346:    const { data: discountCode, error: discountError } = await supabase
./api/admin-server.cjs:347:      .from('discount_codes')
./api/admin-server.cjs:352:    if (discountError || !discountCode) {
./api/admin-server.cjs:353:      return res.status(400).json({ error: 'Invalid discount code' });
./api/admin-server.cjs:358:      .from('discount_code_usage')
./api/admin-server.cjs:360:        discount_code_id: discountCode.id,
./api/admin-server.cjs:363:        discount_amount: discountAmount,
./api/admin-server.cjs:377:      .from('discount_codes')
./api/admin-server.cjs:381:      .eq('id', discountCode.id);
./api/admin-server.cjs:389:    console.error('Apply discount error:', error);
./api/admin-server.cjs:390:    res.status(500).json({ error: 'Failed to apply discount code' });
./api/admin-server.cjs:397:    // Get total discount codes
./api/admin-server.cjs:399:      .from('discount_codes')
./api/admin-server.cjs:402:    // Get active discount codes
./api/admin-server.cjs:404:      .from('discount_codes')
./api/admin-server.cjs:413:      .from('discount_code_usage')
./api/admin-server.cjs:419:      .from('discount_code_usage')
./api/admin-server.cjs:420:      .select('discount_amount');
./api/admin-server.cjs:423:      sum + parseFloat(usage.discount_amount), 0) || 0;
./api/admin-server.cjs:473:        discount_codes (
./api/admin-server.cjs:476:          discount_type,
./api/admin-server.cjs:477:          discount_value
./api/admin-server.cjs:509:        discount_codes (
./api/admin-server.cjs:512:          discount_type,
./api/admin-server.cjs:513:          discount_value
./api/admin-server.cjs:541:// Create order with discount validation
./api/admin-server.cjs:550:      discount_code,
./api/admin-server.cjs:555:    let discountCodeData = null;
./api/admin-server.cjs:556:    let discountAmount = 0;
./api/admin-server.cjs:559:    // Validate discount code if provided
./api/admin-server.cjs:560:    if (discount_code) {
./api/admin-server.cjs:562:        .rpc('validate_discount_code', {
./api/admin-server.cjs:563:          p_code: discount_code.toUpperCase(),
./api/admin-server.cjs:570:          error: validation?.error || 'Invalid discount code' 
./api/admin-server.cjs:574:      // Get discount code details
./api/admin-server.cjs:575:      const { data: discountCode, error: dcError } = await supabase
./api/admin-server.cjs:576:        .from('discount_codes')
./api/admin-server.cjs:578:        .eq('code', discount_code.toUpperCase())
./api/admin-server.cjs:581:      if (!dcError && discountCode) {
./api/admin-server.cjs:582:        discountCodeData = discountCode;
./api/admin-server.cjs:583:        discountAmount = validation.discount_amount;
./api/admin-server.cjs:604:        discount_code_id: discountCodeData?.id || null,
./api/admin-server.cjs:605:        discount_code: discount_code || null,
./api/admin-server.cjs:606:        discount_amount,
./api/admin-server.cjs:607:        discount_type: discountCodeData?.discount_type || null,
./api/admin-server.cjs:620:    // Record discount usage if applicable
./api/admin-server.cjs:621:    if (discountCodeData && discountAmount > 0) {
./api/admin-server.cjs:623:        .from('discount_code_usage')
./api/admin-server.cjs:625:          discount_code_id: discountCodeData.id,
./api/admin-server.cjs:628:          discount_amount: discountAmount,
./api/admin-server.cjs:636:        .from('discount_codes')
./api/admin-server.cjs:638:        .eq('id', discountCodeData.id);
./api/admin-server.cjs:736:        discount_amount,
./api/admin-server.cjs:738:        discount_codes (
./api/admin-server.cjs:752:    const totalDiscount = orders.reduce((sum, order) => sum + parseFloat(order.discount_amount || 0), 0);
./api/admin-server.cjs:762:    // Top discount codes used
./api/admin-server.cjs:763:    const discountUsage = orders
./api/admin-server.cjs:764:      .filter(order => order.discount_codes)
./api/admin-server.cjs:766:        const code = order.discount_codes.code;
./api/admin-server.cjs:776:        totalDiscount: totalDiscount.toFixed(2),
./api/admin-server.cjs:780:        topDiscountCodes: Object.entries(discountUsage)
./api/admin-server.cjs:827:    console.log(`   GET  /api/admin/discount-codes`);
./api/admin-server.cjs:828:    console.log(`   POST /api/admin/discount-codes`);
./api/admin-server.cjs:829:    console.log(`   PUT  /api/admin/discount-codes/:id`);
./api/admin-server.cjs:830:    console.log(`   DELETE /api/admin/discount-codes/:id`);
./api/admin-server.cjs:835:    console.log(`   SUPABASE_URL: ${supabaseUrl}`);
./api/test.js:14:      hasSupabaseUrl: !!process.env.SUPABASE_URL,
./api/test.js:15:      hasSupabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
./api/test.js:24:        hasSupabaseUrl: !!process.env.SUPABASE_URL,
./api/test.js:25:        hasSupabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
./api/orders.js:4:  process.env.SUPABASE_URL,
./api/orders.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./api/orders.js:38:      discount_code,
./api/orders.js:39:      discount_amount = 0,
./api/orders.js:52:    // Calculate original total (before discount)
./api/orders.js:53:    const original_total = discount_amount > 0 ? subtotal + shipping + tax : total;
./api/orders.js:67:        discount_code,
./api/orders.js:68:        discount_amount,
./api/admin/dashboard-stats.js:4:const supabaseUrl = process.env.VITE_SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./api/admin/dashboard-stats.js:5:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./api/admin/dashboard-stats.js:6:const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./api/admin/dashboard-stats.js:9:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./api/admin/dashboard-stats.js:66:    // Get total discount codes
./api/admin/dashboard-stats.js:68:      .from('discount_codes')
./api/admin/dashboard-stats.js:71:    // Get active discount codes
./api/admin/dashboard-stats.js:73:      .from('discount_codes')
./api/admin/dashboard-stats.js:82:      .from('discount_code_usage')
./api/admin/dashboard-stats.js:88:      .from('discount_code_usage')
./api/admin/dashboard-stats.js:89:      .select('discount_amount');
./api/admin/dashboard-stats.js:92:      sum + parseFloat(usage.discount_amount), 0) || 0;
./api/admin/orders.js:4:  process.env.SUPABASE_URL,
./api/admin/orders.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./api/admin/orders.js:80:          total_discounts: 0
./api/admin/orders.js:99:        discount_code,
./api/admin/orders.js:100:        discount_amount,
./api/admin/discount-codes.js:4:const supabaseUrl = process.env.SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./api/admin/discount-codes.js:5:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./api/admin/discount-codes.js:6:const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./api/admin/discount-codes.js:15:  console.error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./api/admin/discount-codes.js:16:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./api/admin/discount-codes.js:70:      // Get all discount codes
./api/admin/discount-codes.js:72:        .from('discount_codes')
./api/admin/discount-codes.js:83:      // Create new discount code
./api/admin/discount-codes.js:88:        discount_type,
./api/admin/discount-codes.js:89:        discount_value,
./api/admin/discount-codes.js:91:        maximum_discount_amount,
./api/admin/discount-codes.js:99:      if (!code || !discount_type || !discount_value) {
./api/admin/discount-codes.js:101:          error: 'Code, discount_type, and discount_value are required' 
./api/admin/discount-codes.js:106:        .from('discount_codes')
./api/admin/discount-codes.js:111:          discount_type,
./api/admin/discount-codes.js:112:          discount_value,
./api/admin/discount-codes.js:114:          maximum_discount_amount,
./api/admin/discount-codes.js:126:          return res.status(400).json({ error: 'Discount code already exists' });
./api/admin/discount-codes.js:134:      // Update discount code (expecting ID in URL path or body)
./api/admin/discount-codes.js:146:        .from('discount_codes')
./api/admin/discount-codes.js:157:        return res.status(404).json({ error: 'Discount code not found' });
./api/admin/discount-codes.js:163:      // Delete discount code (expecting ID in URL query or body)
./api/admin/discount-codes.js:171:        .from('discount_codes')
./api/admin/discount-codes.js:183:        return res.status(404).json({ error: 'Discount code not found' });
./api/admin/discount-codes.js:186:      return res.json({ success: true, message: 'Discount code deleted successfully', data });
./api/admin/discount-codes.js:193:    console.error('Discount codes API error:', error);
./api/send-order-emails.js:18:    const resendApiKey = process.env.VITE_RESEND_API_KEY;
./api/validate-discount.js:4:  process.env.SUPABASE_URL,
./api/validate-discount.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./api/validate-discount.js:27:        error: 'Discount code is required'
./api/validate-discount.js:31:    // Call the database function to validate the discount code
./api/validate-discount.js:33:      .rpc('validate_discount_code', {
./api/validate-discount.js:42:        error: 'Failed to validate discount code'
./api/validate-discount.js:52:          error: 'Invalid discount code'
./api/validate-discount.js:63:      discount_type: result.discount_type,
./api/validate-discount.js:64:      discount_value: result.discount_value,
./api/validate-discount.js:65:      discount_amount: result.discount_amount,
./api/validate-discount.js:68:      savings: result.discount_amount,
./api/validate-discount.js:77:    console.error('Validate discount error:', error);
./.env.example:2:VITE_RESEND_API_KEY=your_resend_api_key_here
./.env.example:5:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./.env.example:6:VITE_SUPABASE_ANON_KEY=your_supabase_anon_key_here
./.env.example:10:SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key_here
./.git/COMMIT_EDITMSG:8:- WELCOME10 discount code for new users
./INTEGRATION_GUIDE.md:1:# Integration Guide: Adding Discount Codes to Checkout
./INTEGRATION_GUIDE.md:3:This guide shows how to integrate the discount code system with your existing AlphaPrint and Silverback checkout forms.
./INTEGRATION_GUIDE.md:12:import orderService, { DiscountValidation } from '@/services/orderService';
./INTEGRATION_GUIDE.md:20:const [discountCode, setDiscountCode] = useState('');
./INTEGRATION_GUIDE.md:21:const [discountValidation, setDiscountValidation] = useState<DiscountValidation | null>(null);
./INTEGRATION_GUIDE.md:22:const [validatingDiscount, setValidatingDiscount] = useState(false);
./INTEGRATION_GUIDE.md:23:const [discountError, setDiscountError] = useState('');
./INTEGRATION_GUIDE.md:28:### Add Discount Code Input
./INTEGRATION_GUIDE.md:33:{/* Discount Code Section */}
./INTEGRATION_GUIDE.md:36:    <CardTitle className="text-lg">Discount Code</CardTitle>
./INTEGRATION_GUIDE.md:37:    <CardDescription>Enter a valid discount code to save money</CardDescription>
./INTEGRATION_GUIDE.md:42:        placeholder="Enter discount code"
./INTEGRATION_GUIDE.md:43:        value={discountCode}
./INTEGRATION_GUIDE.md:44:        onChange={(e) => setDiscountCode(e.target.value.toUpperCase())}
./INTEGRATION_GUIDE.md:45:        disabled={validatingDiscount}
./INTEGRATION_GUIDE.md:50:        onClick={handleValidateDiscount}
./INTEGRATION_GUIDE.md:51:        disabled={!discountCode || validatingDiscount}
./INTEGRATION_GUIDE.md:53:        {validatingDiscount ? (
./INTEGRATION_GUIDE.md:64:    {discountError && (
./INTEGRATION_GUIDE.md:66:        <AlertDescription>{discountError}</AlertDescription>
./INTEGRATION_GUIDE.md:70:    {discountValidation?.valid && (
./INTEGRATION_GUIDE.md:74:          <strong>{discountValidation.name}</strong> applied! 
./INTEGRATION_GUIDE.md:75:          You save {discountValidation.discount_type === 'percentage' 
./INTEGRATION_GUIDE.md:76:            ? `${discountValidation.discount_value}%` 
./INTEGRATION_GUIDE.md:77:            : `€${discountValidation.discount_amount}`}
./INTEGRATION_GUIDE.md:82:            onClick={handleRemoveDiscount}
./INTEGRATION_GUIDE.md:96:const handleValidateDiscount = async () => {
./INTEGRATION_GUIDE.md:97:  if (!discountCode.trim()) return;
./INTEGRATION_GUIDE.md:99:  setValidatingDiscount(true);
./INTEGRATION_GUIDE.md:100:  setDiscountError('');
./INTEGRATION_GUIDE.md:102:  const validation = await orderService.validateDiscountCode(
./INTEGRATION_GUIDE.md:103:    discountCode,
./INTEGRATION_GUIDE.md:109:    setDiscountValidation(validation);
./INTEGRATION_GUIDE.md:110:    setDiscountError('');
./INTEGRATION_GUIDE.md:112:    setDiscountValidation(null);
./INTEGRATION_GUIDE.md:113:    setDiscountError(validation.error || 'Invalid discount code');
./INTEGRATION_GUIDE.md:116:  setValidatingDiscount(false);
./INTEGRATION_GUIDE.md:119:const handleRemoveDiscount = () => {
./INTEGRATION_GUIDE.md:120:  setDiscountCode('');
./INTEGRATION_GUIDE.md:121:  setDiscountValidation(null);
./INTEGRATION_GUIDE.md:122:  setDiscountError('');
./INTEGRATION_GUIDE.md:128:Update your order summary to show discount:
./INTEGRATION_GUIDE.md:144:  {/* Discount */}
./INTEGRATION_GUIDE.md:145:  {discountValidation?.valid && (
./INTEGRATION_GUIDE.md:148:        Discount ({discountValidation.code}):
./INTEGRATION_GUIDE.md:151:        -€{discountValidation.discount_amount?.toFixed(2)}
./INTEGRATION_GUIDE.md:179:// Calculate totals with discount
./INTEGRATION_GUIDE.md:185:const discountAmount = discountValidation?.discount_amount || 0;
./INTEGRATION_GUIDE.md:186:const discountedSubtotal = Math.max(0, subtotalAmount - discountAmount);
./INTEGRATION_GUIDE.md:187:const finalTotal = discountedSubtotal + shippingCost;
./INTEGRATION_GUIDE.md:194:When creating the payment intent, include discount information:
./INTEGRATION_GUIDE.md:202:  discountCode: discountValidation?.code,
./INTEGRATION_GUIDE.md:203:  discountAmount: discountValidation?.discount_amount || 0,
./INTEGRATION_GUIDE.md:210:After successful payment, create the order with discount:
./INTEGRATION_GUIDE.md:233:  discount_code: discountValidation?.code,
./INTEGRATION_GUIDE.md:253:import orderService, { DiscountValidation } from '@/services/orderService';
./INTEGRATION_GUIDE.md:256:  const [discountCode, setDiscountCode] = useState('');
./INTEGRATION_GUIDE.md:257:  const [discountValidation, setDiscountValidation] = useState<DiscountValidation | null>(null);
./INTEGRATION_GUIDE.md:261:  const handleValidateDiscount = async () => {
./INTEGRATION_GUIDE.md:262:    if (!discountCode.trim()) return;
./INTEGRATION_GUIDE.md:264:    const validation = await orderService.validateDiscountCode(
./INTEGRATION_GUIDE.md:265:      discountCode,
./INTEGRATION_GUIDE.md:271:      setDiscountValidation(validation);
./INTEGRATION_GUIDE.md:280:    const discountAmount = discountValidation?.discount_amount || 0;
./INTEGRATION_GUIDE.md:281:    return Math.max(0, basePrice - discountAmount);
./INTEGRATION_GUIDE.md:297:  const [discountValidation, setDiscountValidation] = useState(null);
./INTEGRATION_GUIDE.md:305:    discountValidation
./INTEGRATION_GUIDE.md:320:SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
./INTEGRATION_GUIDE.md:321:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./INTEGRATION_GUIDE.md:322:VITE_SUPABASE_ANON_KEY=your_anon_key_here
./INTEGRATION_GUIDE.md:336:# Terminal 3: Admin API (for discount codes)
./INTEGRATION_GUIDE.md:343:## 📊 Available Discount Codes
./INTEGRATION_GUIDE.md:360:3. Enter discount code: `WELCOME10`
./INTEGRATION_GUIDE.md:361:4. Verify discount is applied
./INTEGRATION_GUIDE.md:370:- See discount code usage analytics
./INTEGRATION_GUIDE.md:371:- Create/edit/delete discount codes
./INTEGRATION_GUIDE.md:375:This integration provides a complete discount code system that works with both your AlphaPrint custom design flow and regular Silverback product checkout!
./debug_report.md:4:- ❌ **SUPABASE_SERVICE_ROLE_KEY is invalid/expired**
./debug_report.md:11:  "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*&limit=1"
./debug_report.md:23:4. Replace `SUPABASE_SERVICE_ROLE_KEY` in your `.env` file
./debug_report.md:28:- ✅ Admin API: `localhost:3002` (discount codes, orders)  
./debug_report.md:41:# Discount codes (after fixing Supabase key)
./debug_report.md:42:curl http://localhost:3002/api/admin/discount-codes
./debug_report.md:46:- 🔧 **NEEDS FIXING:** Update SUPABASE_SERVICE_ROLE_KEY in .env
./discount_grep.txt:1:./.env.production:3:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./discount_grep.txt:2:./.env.production:6:VITE_STRIPE_PUBLISHABLE_KEY=pk_live_51PDOJERwnR6blBksJj5d1YRS3qullycUda6G48z2ETGJvHd7AvOt061oFLkgWNo6g1c4uNZVOoU64MFDnOeKtjiK00QGDX8qy7
./discount_grep.txt:3:./.env.local:3:VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51RxmfY2KYnpDQ8IOWO0gcvEpdMV1PhiVW77btj56Bm1a9E2XWZkUGP1uOfZFcrFZlT94xoNbWctMuJdAP0J58IOR00clddWmZU
./discount_grep.txt:4:./.env.local:4:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./discount_grep.txt:6:./local-api-server.cjs:63:    const resendApiKey = process.env.VITE_RESEND_API_KEY;
./discount_grep.txt:7:./local-api-server.cjs:263:    console.log(`   RESEND_API_KEY: ${process.env.VITE_RESEND_API_KEY ? '✅ Set' : '❌ Missing'}`);
./discount_grep.txt:8:./ADMIN_SETUP.md:1:# Admin Discount Code Management System
./discount_grep.txt:9:./ADMIN_SETUP.md:3:This document explains how to set up and use the admin system for managing discount codes for both AlphaPrint and Silverback checkout.
./discount_grep.txt:10:./ADMIN_SETUP.md:26:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:11:./ADMIN_SETUP.md:27:VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI
./discount_grep.txt:12:./ADMIN_SETUP.md:31:SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
./discount_grep.txt:13:./ADMIN_SETUP.md:85:- **Discount Code Management**: Create, edit, activate/deactivate, and delete codes
./discount_grep.txt:14:./ADMIN_SETUP.md:88:### Creating Discount Codes
./discount_grep.txt:15:./ADMIN_SETUP.md:96:   - **Value**: Discount value (10 for 10% or 20.00 for €20)
./discount_grep.txt:16:./ADMIN_SETUP.md:103:The system comes with these pre-configured discount codes:
./discount_grep.txt:17:./ADMIN_SETUP.md:117:- `GET /api/admin/discount-codes` - List all discount codes
./discount_grep.txt:18:./ADMIN_SETUP.md:118:- `POST /api/admin/discount-codes` - Create new discount code
./discount_grep.txt:19:./ADMIN_SETUP.md:119:- `PUT /api/admin/discount-codes/:id` - Update discount code
./discount_grep.txt:20:./ADMIN_SETUP.md:120:- `DELETE /api/admin/discount-codes/:id` - Delete discount code
./discount_grep.txt:21:./ADMIN_SETUP.md:121:- `GET /api/admin/discount-usage` - Usage analytics
./discount_grep.txt:22:./ADMIN_SETUP.md:125:- `POST /api/validate-discount` - Validate a discount code
./discount_grep.txt:23:./ADMIN_SETUP.md:126:- `POST /api/apply-discount` - Apply and record discount usage
./discount_grep.txt:24:./ADMIN_SETUP.md:132:You can validate discount codes from your checkout forms:
./discount_grep.txt:25:./ADMIN_SETUP.md:135:// Validate discount code
./discount_grep.txt:26:./ADMIN_SETUP.md:136:const response = await fetch('http://localhost:3002/api/validate-discount', {
./discount_grep.txt:27:./ADMIN_SETUP.md:151:  console.log('Discount applied:', result.validation);
./discount_grep.txt:28:./ADMIN_SETUP.md:152:  // Apply discount to order
./discount_grep.txt:29:./ADMIN_SETUP.md:161:// After successful payment, record the discount usage
./discount_grep.txt:30:./ADMIN_SETUP.md:162:await fetch('http://localhost:3002/api/apply-discount', {
./discount_grep.txt:31:./ADMIN_SETUP.md:171:    discountAmount: 20.00,
./discount_grep.txt:32:./ADMIN_SETUP.md:201:- `discount_codes` - Stores all discount codes
./discount_grep.txt:33:./ADMIN_SETUP.md:202:- `discount_code_usage` - Tracks usage for analytics
./discount_grep.txt:34:./ADMIN_SETUP.md:211:1. **"Authentication failed"** - Check that SUPABASE_SERVICE_ROLE_KEY is correct
./discount_grep.txt:35:./DISCOUNT_CODE_ANALYSIS.md:1:# 🎫 COMPLETE DISCOUNT CODE API ANALYSIS
./discount_grep.txt:36:./DISCOUNT_CODE_ANALYSIS.md:3:## **📁 ALL DISCOUNT-RELATED FILES:**
./discount_grep.txt:37:./DISCOUNT_CODE_ANALYSIS.md:7:supabase/migrations/20250829135300_create_discount_codes_table.sql
./discount_grep.txt:38:./DISCOUNT_CODE_ANALYSIS.md:14:api/admin/discount-codes.js - Serverless discount codes endpoint  
./discount_grep.txt:39:./DISCOUNT_CODE_ANALYSIS.md:15:api/validate-discount.js - Public discount validation endpoint
./discount_grep.txt:40:./DISCOUNT_CODE_ANALYSIS.md:16:api/orders.js - Order creation with discount support
./discount_grep.txt:41:./DISCOUNT_CODE_ANALYSIS.md:18:api/admin/dashboard-stats.js - Dashboard stats with discount metrics
./discount_grep.txt:42:./DISCOUNT_CODE_ANALYSIS.md:23:src/pages/AdminDashboard.tsx - Admin discount management interface
./discount_grep.txt:43:./DISCOUNT_CODE_ANALYSIS.md:24:src/pages/AlphaPrintStart.tsx - Discount application in print flow
./discount_grep.txt:44:./DISCOUNT_CODE_ANALYSIS.md:25:src/pages/AlphaPrintQuote.tsx - Quote with discount calculation
./discount_grep.txt:45:./DISCOUNT_CODE_ANALYSIS.md:26:src/services/orderService.ts - Order service with discount handling
./discount_grep.txt:46:./DISCOUNT_CODE_ANALYSIS.md:40:- `api/admin/discount-codes.js` (Vercel serverless function)
./discount_grep.txt:47:./DISCOUNT_CODE_ANALYSIS.md:46:curl -s "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*&limit=1"
./discount_grep.txt:48:./DISCOUNT_CODE_ANALYSIS.md:66:// Get all discount codes (admin only) - temporarily bypass auth for testing
./discount_grep.txt:49:./DISCOUNT_CODE_ANALYSIS.md:67:app.get('/api/admin/discount-codes', async (req, res) => {
./discount_grep.txt:50:./DISCOUNT_CODE_ANALYSIS.md:70:      .from('discount_codes')
./discount_grep.txt:51:./DISCOUNT_CODE_ANALYSIS.md:80:    console.error('Get discount codes error:', error);
./discount_grep.txt:52:./DISCOUNT_CODE_ANALYSIS.md:81:    res.status(500).json({ error: 'Failed to fetch discount codes' });
./discount_grep.txt:53:./DISCOUNT_CODE_ANALYSIS.md:88:const fetchDiscountCodes = async () => {
./discount_grep.txt:54:./DISCOUNT_CODE_ANALYSIS.md:99:    const codesUrl = getApiUrl('/api/admin/discount-codes');
./discount_grep.txt:55:./DISCOUNT_CODE_ANALYSIS.md:111:2. **discount_codes Table Missing/Inaccessible** - RLS policies blocking access
./discount_grep.txt:56:./DISCOUNT_CODE_ANALYSIS.md:120:CREATE TABLE IF NOT EXISTS discount_codes (
./discount_grep.txt:57:./DISCOUNT_CODE_ANALYSIS.md:125:  discount_type VARCHAR(20) CHECK (discount_type IN ('percentage', 'fixed_amount')) NOT NULL,
./discount_grep.txt:58:./DISCOUNT_CODE_ANALYSIS.md:126:  discount_value DECIMAL(10,2) NOT NULL,
./discount_grep.txt:59:./DISCOUNT_CODE_ANALYSIS.md:128:  maximum_discount_amount DECIMAL(10,2),
./discount_grep.txt:60:./DISCOUNT_CODE_ANALYSIS.md:140:ALTER TABLE discount_codes ENABLE ROW LEVEL SECURITY;
./discount_grep.txt:61:./DISCOUNT_CODE_ANALYSIS.md:143:CREATE POLICY "Admin can manage discount codes" ON discount_codes
./discount_grep.txt:62:./DISCOUNT_CODE_ANALYSIS.md:149:CREATE POLICY "Service role full access" ON discount_codes
./discount_grep.txt:63:./DISCOUNT_CODE_ANALYSIS.md:158:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:64:./DISCOUNT_CODE_ANALYSIS.md:159:VITE_SUPABASE_ANON_KEY=<your_actual_anon_key>
./discount_grep.txt:65:./DISCOUNT_CODE_ANALYSIS.md:160:SUPABASE_SERVICE_ROLE_KEY=<your_actual_service_role_key>
./discount_grep.txt:66:./DISCOUNT_CODE_ANALYSIS.md:168:     "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*"
./discount_grep.txt:67:./DISCOUNT_CODE_ANALYSIS.md:175:curl http://localhost:3002/api/admin/discount-codes
./discount_grep.txt:68:./supabase/migrations/20250829135300_create_discount_codes_table.sql:1:-- Create discount_codes table for managing discount codes
./discount_grep.txt:69:./supabase/migrations/20250829135300_create_discount_codes_table.sql:2:CREATE TABLE public.discount_codes (
./discount_grep.txt:70:./supabase/migrations/20250829135300_create_discount_codes_table.sql:7:  discount_type TEXT NOT NULL CHECK (discount_type IN ('percentage', 'fixed_amount')),
./discount_grep.txt:71:./supabase/migrations/20250829135300_create_discount_codes_table.sql:8:  discount_value DECIMAL(10,2) NOT NULL CHECK (discount_value > 0),
./discount_grep.txt:72:./supabase/migrations/20250829135300_create_discount_codes_table.sql:10:  maximum_discount_amount DECIMAL(10,2) CHECK (maximum_discount_amount IS NULL OR maximum_discount_amount > 0),
./discount_grep.txt:73:./supabase/migrations/20250829135300_create_discount_codes_table.sql:25:CREATE INDEX idx_discount_codes_code ON public.discount_codes (code);
./discount_grep.txt:74:./supabase/migrations/20250829135300_create_discount_codes_table.sql:26:CREATE INDEX idx_discount_codes_is_active ON public.discount_codes (is_active);
./discount_grep.txt:75:./supabase/migrations/20250829135300_create_discount_codes_table.sql:27:CREATE INDEX idx_discount_codes_valid_dates ON public.discount_codes (valid_from, valid_until);
./discount_grep.txt:76:./supabase/migrations/20250829135300_create_discount_codes_table.sql:28:CREATE INDEX idx_discount_codes_created_at ON public.discount_codes (created_at DESC);
./discount_grep.txt:77:./supabase/migrations/20250829135300_create_discount_codes_table.sql:31:ALTER TABLE public.discount_codes ENABLE ROW LEVEL SECURITY;
./discount_grep.txt:78:./supabase/migrations/20250829135300_create_discount_codes_table.sql:33:-- RLS Policies for discount codes
./discount_grep.txt:79:./supabase/migrations/20250829135300_create_discount_codes_table.sql:34:-- Public can view active discount codes for validation
./discount_grep.txt:80:./supabase/migrations/20250829135300_create_discount_codes_table.sql:35:CREATE POLICY "Active discount codes are viewable by everyone" ON public.discount_codes
./discount_grep.txt:81:./supabase/migrations/20250829135300_create_discount_codes_table.sql:38:-- Admin can view all discount codes
./discount_grep.txt:82:./supabase/migrations/20250829135300_create_discount_codes_table.sql:39:CREATE POLICY "Admin can view all discount codes" ON public.discount_codes
./discount_grep.txt:83:./supabase/migrations/20250829135300_create_discount_codes_table.sql:48:-- Admin can insert discount codes
./discount_grep.txt:84:./supabase/migrations/20250829135300_create_discount_codes_table.sql:49:CREATE POLICY "Admin can insert discount codes" ON public.discount_codes
./discount_grep.txt:85:./supabase/migrations/20250829135300_create_discount_codes_table.sql:58:-- Admin can update discount codes
./discount_grep.txt:86:./supabase/migrations/20250829135300_create_discount_codes_table.sql:59:CREATE POLICY "Admin can update discount codes" ON public.discount_codes
./discount_grep.txt:87:./supabase/migrations/20250829135300_create_discount_codes_table.sql:68:-- Admin can delete discount codes
./discount_grep.txt:88:./supabase/migrations/20250829135300_create_discount_codes_table.sql:69:CREATE POLICY "Admin can delete discount codes" ON public.discount_codes
./discount_grep.txt:89:./supabase/migrations/20250829135300_create_discount_codes_table.sql:79:CREATE TRIGGER update_discount_codes_updated_at
./discount_grep.txt:90:./supabase/migrations/20250829135300_create_discount_codes_table.sql:80:  BEFORE UPDATE ON public.discount_codes
./discount_grep.txt:91:./supabase/migrations/20250829135300_create_discount_codes_table.sql:84:-- Insert some sample discount codes for testing (optional)
./discount_grep.txt:92:./supabase/migrations/20250829135300_create_discount_codes_table.sql:85:INSERT INTO public.discount_codes (code, name, description, discount_type, discount_value, minimum_order_amount, is_active) VALUES
./discount_grep.txt:93:./supabase/migrations/20250829135300_create_discount_codes_table.sql:90:-- Create function to validate and use discount codes
./discount_grep.txt:94:./supabase/migrations/20250829135300_create_discount_codes_table.sql:91:CREATE OR REPLACE FUNCTION validate_discount_code(
./discount_grep.txt:95:./supabase/migrations/20250829135300_create_discount_codes_table.sql:98:  discount_id UUID,
./discount_grep.txt:96:./supabase/migrations/20250829135300_create_discount_codes_table.sql:102:  discount_type TEXT,
./discount_grep.txt:97:./supabase/migrations/20250829135300_create_discount_codes_table.sql:103:  discount_value DECIMAL,
./discount_grep.txt:98:./supabase/migrations/20250829135300_create_discount_codes_table.sql:104:  discount_amount DECIMAL,
./discount_grep.txt:99:./supabase/migrations/20250829135300_create_discount_codes_table.sql:109:  v_discount public.discount_codes%ROWTYPE;
./discount_grep.txt:100:./supabase/migrations/20250829135300_create_discount_codes_table.sql:110:  v_discount_amount DECIMAL;
./discount_grep.txt:101:./supabase/migrations/20250829135300_create_discount_codes_table.sql:113:  -- Find the discount code
./discount_grep.txt:102:./supabase/migrations/20250829135300_create_discount_codes_table.sql:114:  SELECT * INTO v_discount 
./discount_grep.txt:103:./supabase/migrations/20250829135300_create_discount_codes_table.sql:115:  FROM public.discount_codes 
./discount_grep.txt:104:./supabase/migrations/20250829135300_create_discount_codes_table.sql:116:  WHERE UPPER(discount_codes.code) = UPPER(p_code)
./discount_grep.txt:105:./supabase/migrations/20250829135300_create_discount_codes_table.sql:121:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Invalid discount code';
./discount_grep.txt:106:./supabase/migrations/20250829135300_create_discount_codes_table.sql:126:  IF (v_discount.valid_from IS NOT NULL AND v_discount.valid_from > now()) OR
./discount_grep.txt:107:./supabase/migrations/20250829135300_create_discount_codes_table.sql:127:     (v_discount.valid_until IS NOT NULL AND v_discount.valid_until < now()) THEN
./discount_grep.txt:108:./supabase/migrations/20250829135300_create_discount_codes_table.sql:128:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Discount code has expired or is not yet valid';
./discount_grep.txt:109:./supabase/migrations/20250829135300_create_discount_codes_table.sql:133:  IF v_discount.usage_limit IS NOT NULL AND v_discount.used_count >= v_discount.usage_limit THEN
./discount_grep.txt:110:./supabase/migrations/20250829135300_create_discount_codes_table.sql:134:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Discount code usage limit exceeded';
./discount_grep.txt:111:./supabase/migrations/20250829135300_create_discount_codes_table.sql:139:  IF p_order_amount IS NOT NULL AND p_order_amount < v_discount.minimum_order_amount THEN
./discount_grep.txt:112:./supabase/migrations/20250829135300_create_discount_codes_table.sql:141:      format('Minimum order amount of €%.2f required', v_discount.minimum_order_amount);
./discount_grep.txt:113:./supabase/migrations/20250829135300_create_discount_codes_table.sql:145:  -- Calculate discount amount
./discount_grep.txt:114:./supabase/migrations/20250829135300_create_discount_codes_table.sql:146:  IF v_discount.discount_type = 'percentage' THEN
./discount_grep.txt:115:./supabase/migrations/20250829135300_create_discount_codes_table.sql:147:    v_discount_amount := (p_order_amount * v_discount.discount_value / 100);
./discount_grep.txt:116:./supabase/migrations/20250829135300_create_discount_codes_table.sql:148:    -- Apply maximum discount limit if set
./discount_grep.txt:117:./supabase/migrations/20250829135300_create_discount_codes_table.sql:149:    IF v_discount.maximum_discount_amount IS NOT NULL THEN
./discount_grep.txt:118:./supabase/migrations/20250829135300_create_discount_codes_table.sql:150:      v_discount_amount := LEAST(v_discount_amount, v_discount.maximum_discount_amount);
./discount_grep.txt:119:./supabase/migrations/20250829135300_create_discount_codes_table.sql:153:    v_discount_amount := v_discount.discount_value;
./discount_grep.txt:120:./supabase/migrations/20250829135300_create_discount_codes_table.sql:157:  v_final_amount := GREATEST(0, COALESCE(p_order_amount, 0) - v_discount_amount);
./discount_grep.txt:121:./supabase/migrations/20250829135300_create_discount_codes_table.sql:159:  -- Return valid discount
./discount_grep.txt:122:./supabase/migrations/20250829135300_create_discount_codes_table.sql:162:    v_discount.id,
./discount_grep.txt:123:./supabase/migrations/20250829135300_create_discount_codes_table.sql:163:    v_discount.code,
./discount_grep.txt:124:./supabase/migrations/20250829135300_create_discount_codes_table.sql:164:    v_discount.name,
./discount_grep.txt:125:./supabase/migrations/20250829135300_create_discount_codes_table.sql:165:    v_discount.description,
./discount_grep.txt:126:./supabase/migrations/20250829135300_create_discount_codes_table.sql:166:    v_discount.discount_type,
./discount_grep.txt:127:./supabase/migrations/20250829135300_create_discount_codes_table.sql:167:    v_discount.discount_value,
./discount_grep.txt:128:./supabase/migrations/20250829135300_create_discount_codes_table.sql:168:    v_discount_amount,
./discount_grep.txt:129:./supabase/migrations/20250829135300_create_discount_codes_table.sql:175:CREATE OR REPLACE FUNCTION increment_discount_usage(p_discount_id UUID)
./discount_grep.txt:130:./supabase/migrations/20250829135300_create_discount_codes_table.sql:178:  UPDATE public.discount_codes 
./discount_grep.txt:131:./supabase/migrations/20250829135300_create_discount_codes_table.sql:181:  WHERE id = p_discount_id;
./discount_grep.txt:132:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:6:ADD COLUMN discount_code TEXT,
./discount_grep.txt:133:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:7:ADD COLUMN discount_amount DECIMAL(10,2) DEFAULT 0;
./discount_grep.txt:134:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:12:-- Add index for discount code analytics
./discount_grep.txt:135:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:13:CREATE INDEX idx_orders_discount_code ON public.orders (discount_code);
./discount_grep.txt:136:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:54:  total_discounts DECIMAL
./discount_grep.txt:137:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:75:    COALESCE(SUM(discount_amount), 0)::DECIMAL as total_discounts
./discount_grep.txt:138:./package-lock.json:2:  "name": "vite_react_shadcn_ts",
./discount_grep.txt:139:./package-lock.json:8:      "name": "vite_react_shadcn_ts",
./discount_grep.txt:140:./package.json:2:  "name": "vite_react_shadcn_ts",
./discount_grep.txt:141:./.env:2:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./discount_grep.txt:142:./.env:6:VITE_STRIPE_PUBLISHABLE_KEY=pk_live_51PDOJERwnR6blBksJj5d1YRS3qullycUda6G48z2ETGJvHd7AvOt061oFLkgWNo6g1c4uNZVOoU64MFDnOeKtjiK00QGDX8qy7
./discount_grep.txt:143:./.env:10:# VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51RxmfY2KYnpDQ8IOWO0gcvEpdMV1PhiVW77btj56Bm1a9E2XWZkUGP1uOfZFcrFZlT94xoNbWctMuJdAP0J58IOR00clddWmZU
./discount_grep.txt:144:./.env:14:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:145:./.env:15:VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI
./discount_grep.txt:146:./.env:16:SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTM3MzEzNiwiZXhwIjoyMDcwOTQ5MTM2fQ.1aOdVqBHXMlGDlL1M4EtV_EkCa5i7PQ9m6B7IxoEPbE
./discount_grep.txt:147:./api/admin-server.cjs:10:const supabaseUrl = process.env.VITE_SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./discount_grep.txt:148:./api/admin-server.cjs:11:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./discount_grep.txt:149:./api/admin-server.cjs:14:  console.error('❌ SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:150:./api/admin-server.cjs:15:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:151:./api/admin-server.cjs:46:    const anonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./discount_grep.txt:152:./api/admin-server.cjs:107:// Get all discount codes (admin only) - temporarily bypass auth for testing
./discount_grep.txt:153:./api/admin-server.cjs:108:app.get('/api/admin/discount-codes', async (req, res) => {
./discount_grep.txt:154:./api/admin-server.cjs:111:      .from('discount_codes')
./discount_grep.txt:155:./api/admin-server.cjs:121:    console.error('Get discount codes error:', error);
./discount_grep.txt:156:./api/admin-server.cjs:122:    res.status(500).json({ error: 'Failed to fetch discount codes' });
./discount_grep.txt:157:./api/admin-server.cjs:126:// Create new discount code (admin only)
./discount_grep.txt:158:./api/admin-server.cjs:127:app.post('/api/admin/discount-codes', verifyAdmin, async (req, res) => {
./discount_grep.txt:159:./api/admin-server.cjs:133:      discount_type,
./discount_grep.txt:160:./api/admin-server.cjs:134:      discount_value,
./discount_grep.txt:161:./api/admin-server.cjs:136:      maximum_discount_amount,
./discount_grep.txt:162:./api/admin-server.cjs:144:    if (!code || !discount_type || !discount_value) {
./discount_grep.txt:163:./api/admin-server.cjs:146:        error: 'Code, discount_type, and discount_value are required' 
./discount_grep.txt:164:./api/admin-server.cjs:151:      .from('discount_codes')
./discount_grep.txt:165:./api/admin-server.cjs:156:        discount_type,
./discount_grep.txt:166:./api/admin-server.cjs:157:        discount_value,
./discount_grep.txt:167:./api/admin-server.cjs:159:        maximum_discount_amount,
./discount_grep.txt:168:./api/admin-server.cjs:171:        return res.status(400).json({ error: 'Discount code already exists' });
./discount_grep.txt:169:./api/admin-server.cjs:178:    console.error('Create discount code error:', error);
./discount_grep.txt:170:./api/admin-server.cjs:179:    res.status(500).json({ error: 'Failed to create discount code' });
./discount_grep.txt:171:./api/admin-server.cjs:183:// Update discount code (admin only)
./discount_grep.txt:172:./api/admin-server.cjs:184:app.put('/api/admin/discount-codes/:id', verifyAdmin, async (req, res) => {
./discount_grep.txt:173:./api/admin-server.cjs:195:      .from('discount_codes')
./discount_grep.txt:174:./api/admin-server.cjs:206:      return res.status(404).json({ error: 'Discount code not found' });
./discount_grep.txt:175:./api/admin-server.cjs:211:    console.error('Update discount code error:', error);
./discount_grep.txt:176:./api/admin-server.cjs:212:    res.status(500).json({ error: 'Failed to update discount code' });
./discount_grep.txt:177:./api/admin-server.cjs:216:// Delete discount code (admin only)
./discount_grep.txt:178:./api/admin-server.cjs:217:app.delete('/api/admin/discount-codes/:id', verifyAdmin, async (req, res) => {
./discount_grep.txt:179:./api/admin-server.cjs:222:      .from('discount_codes')
./discount_grep.txt:180:./api/admin-server.cjs:233:      return res.status(404).json({ error: 'Discount code not found' });
./discount_grep.txt:181:./api/admin-server.cjs:236:    res.json({ success: true, message: 'Discount code deleted successfully' });
./discount_grep.txt:182:./api/admin-server.cjs:238:    console.error('Delete discount code error:', error);
./discount_grep.txt:183:./api/admin-server.cjs:239:    res.status(500).json({ error: 'Failed to delete discount code' });
./discount_grep.txt:184:./api/admin-server.cjs:243:// Get discount code usage analytics (admin only)
./discount_grep.txt:185:./api/admin-server.cjs:244:app.get('/api/admin/discount-usage/:codeId', verifyAdmin, async (req, res) => {
./discount_grep.txt:186:./api/admin-server.cjs:249:      .from('discount_code_usage')
./discount_grep.txt:187:./api/admin-server.cjs:252:        discount_codes (
./discount_grep.txt:188:./api/admin-server.cjs:255:          discount_type,
./discount_grep.txt:189:./api/admin-server.cjs:256:          discount_value
./discount_grep.txt:190:./api/admin-server.cjs:262:      query = query.eq('discount_code_id', codeId);
./discount_grep.txt:191:./api/admin-server.cjs:278:// Get all discount code usage analytics (admin only)
./discount_grep.txt:192:./api/admin-server.cjs:279:app.get('/api/admin/discount-usage', verifyAdmin, async (req, res) => {
./discount_grep.txt:193:./api/admin-server.cjs:284:      .from('discount_code_usage')
./discount_grep.txt:194:./api/admin-server.cjs:287:        discount_codes (
./discount_grep.txt:195:./api/admin-server.cjs:290:          discount_type,
./discount_grep.txt:196:./api/admin-server.cjs:291:          discount_value
./discount_grep.txt:197:./api/admin-server.cjs:297:      query = query.eq('discount_code_id', codeId);
./discount_grep.txt:198:./api/admin-server.cjs:313:// Public endpoint to validate discount codes (for frontend checkout)
./discount_grep.txt:199:./api/admin-server.cjs:314:app.post('/api/validate-discount', async (req, res) => {
./discount_grep.txt:200:./api/admin-server.cjs:323:      .rpc('validate_discount_code', {
./discount_grep.txt:201:./api/admin-server.cjs:335:    console.error('Validate discount error:', error);
./discount_grep.txt:202:./api/admin-server.cjs:336:    res.status(500).json({ error: 'Failed to validate discount code' });
./discount_grep.txt:203:./api/admin-server.cjs:340:// Apply discount code (record usage)
./discount_grep.txt:204:./api/admin-server.cjs:341:app.post('/api/apply-discount', async (req, res) => {
./discount_grep.txt:205:./api/admin-server.cjs:343:    const { code, orderId, customerEmail, discountAmount, orderAmount, ipAddress, userAgent } = req.body;
./discount_grep.txt:206:./api/admin-server.cjs:345:    // First get the discount code ID
./discount_grep.txt:207:./api/admin-server.cjs:346:    const { data: discountCode, error: discountError } = await supabase
./discount_grep.txt:208:./api/admin-server.cjs:347:      .from('discount_codes')
./discount_grep.txt:209:./api/admin-server.cjs:352:    if (discountError || !discountCode) {
./discount_grep.txt:210:./api/admin-server.cjs:353:      return res.status(400).json({ error: 'Invalid discount code' });
./discount_grep.txt:211:./api/admin-server.cjs:358:      .from('discount_code_usage')
./discount_grep.txt:212:./api/admin-server.cjs:360:        discount_code_id: discountCode.id,
./discount_grep.txt:213:./api/admin-server.cjs:363:        discount_amount: discountAmount,
./discount_grep.txt:214:./api/admin-server.cjs:377:      .from('discount_codes')
./discount_grep.txt:215:./api/admin-server.cjs:381:      .eq('id', discountCode.id);
./discount_grep.txt:216:./api/admin-server.cjs:389:    console.error('Apply discount error:', error);
./discount_grep.txt:217:./api/admin-server.cjs:390:    res.status(500).json({ error: 'Failed to apply discount code' });
./discount_grep.txt:218:./api/admin-server.cjs:397:    // Get total discount codes
./discount_grep.txt:219:./api/admin-server.cjs:399:      .from('discount_codes')
./discount_grep.txt:220:./api/admin-server.cjs:402:    // Get active discount codes
./discount_grep.txt:221:./api/admin-server.cjs:404:      .from('discount_codes')
./discount_grep.txt:222:./api/admin-server.cjs:413:      .from('discount_code_usage')
./discount_grep.txt:223:./api/admin-server.cjs:419:      .from('discount_code_usage')
./discount_grep.txt:224:./api/admin-server.cjs:420:      .select('discount_amount');
./discount_grep.txt:225:./api/admin-server.cjs:423:      sum + parseFloat(usage.discount_amount), 0) || 0;
./discount_grep.txt:226:./api/admin-server.cjs:473:        discount_codes (
./discount_grep.txt:227:./api/admin-server.cjs:476:          discount_type,
./discount_grep.txt:228:./api/admin-server.cjs:477:          discount_value
./discount_grep.txt:229:./api/admin-server.cjs:509:        discount_codes (
./discount_grep.txt:230:./api/admin-server.cjs:512:          discount_type,
./discount_grep.txt:231:./api/admin-server.cjs:513:          discount_value
./discount_grep.txt:232:./api/admin-server.cjs:541:// Create order with discount validation
./discount_grep.txt:233:./api/admin-server.cjs:550:      discount_code,
./discount_grep.txt:234:./api/admin-server.cjs:555:    let discountCodeData = null;
./discount_grep.txt:235:./api/admin-server.cjs:556:    let discountAmount = 0;
./discount_grep.txt:236:./api/admin-server.cjs:559:    // Validate discount code if provided
./discount_grep.txt:237:./api/admin-server.cjs:560:    if (discount_code) {
./discount_grep.txt:238:./api/admin-server.cjs:562:        .rpc('validate_discount_code', {
./discount_grep.txt:239:./api/admin-server.cjs:563:          p_code: discount_code.toUpperCase(),
./discount_grep.txt:240:./api/admin-server.cjs:570:          error: validation?.error || 'Invalid discount code' 
./discount_grep.txt:241:./api/admin-server.cjs:574:      // Get discount code details
./discount_grep.txt:242:./api/admin-server.cjs:575:      const { data: discountCode, error: dcError } = await supabase
./discount_grep.txt:243:./api/admin-server.cjs:576:        .from('discount_codes')
./discount_grep.txt:244:./api/admin-server.cjs:578:        .eq('code', discount_code.toUpperCase())
./discount_grep.txt:245:./api/admin-server.cjs:581:      if (!dcError && discountCode) {
./discount_grep.txt:246:./api/admin-server.cjs:582:        discountCodeData = discountCode;
./discount_grep.txt:247:./api/admin-server.cjs:583:        discountAmount = validation.discount_amount;
./discount_grep.txt:248:./api/admin-server.cjs:604:        discount_code_id: discountCodeData?.id || null,
./discount_grep.txt:249:./api/admin-server.cjs:605:        discount_code: discount_code || null,
./discount_grep.txt:250:./api/admin-server.cjs:606:        discount_amount,
./discount_grep.txt:251:./api/admin-server.cjs:607:        discount_type: discountCodeData?.discount_type || null,
./discount_grep.txt:252:./api/admin-server.cjs:620:    // Record discount usage if applicable
./discount_grep.txt:253:./api/admin-server.cjs:621:    if (discountCodeData && discountAmount > 0) {
./discount_grep.txt:254:./api/admin-server.cjs:623:        .from('discount_code_usage')
./discount_grep.txt:255:./api/admin-server.cjs:625:          discount_code_id: discountCodeData.id,
./discount_grep.txt:256:./api/admin-server.cjs:628:          discount_amount: discountAmount,
./discount_grep.txt:257:./api/admin-server.cjs:636:        .from('discount_codes')
./discount_grep.txt:258:./api/admin-server.cjs:638:        .eq('id', discountCodeData.id);
./discount_grep.txt:259:./api/admin-server.cjs:736:        discount_amount,
./discount_grep.txt:260:./api/admin-server.cjs:738:        discount_codes (
./discount_grep.txt:261:./api/admin-server.cjs:752:    const totalDiscount = orders.reduce((sum, order) => sum + parseFloat(order.discount_amount || 0), 0);
./discount_grep.txt:262:./api/admin-server.cjs:762:    // Top discount codes used
./discount_grep.txt:263:./api/admin-server.cjs:763:    const discountUsage = orders
./discount_grep.txt:264:./api/admin-server.cjs:764:      .filter(order => order.discount_codes)
./discount_grep.txt:265:./api/admin-server.cjs:766:        const code = order.discount_codes.code;
./discount_grep.txt:266:./api/admin-server.cjs:776:        totalDiscount: totalDiscount.toFixed(2),
./discount_grep.txt:267:./api/admin-server.cjs:780:        topDiscountCodes: Object.entries(discountUsage)
./discount_grep.txt:268:./api/admin-server.cjs:827:    console.log(`   GET  /api/admin/discount-codes`);
./discount_grep.txt:269:./api/admin-server.cjs:828:    console.log(`   POST /api/admin/discount-codes`);
./discount_grep.txt:270:./api/admin-server.cjs:829:    console.log(`   PUT  /api/admin/discount-codes/:id`);
./discount_grep.txt:271:./api/admin-server.cjs:830:    console.log(`   DELETE /api/admin/discount-codes/:id`);
./discount_grep.txt:272:./api/admin-server.cjs:835:    console.log(`   SUPABASE_URL: ${supabaseUrl}`);
./discount_grep.txt:273:./api/test.js:14:      hasSupabaseUrl: !!process.env.SUPABASE_URL,
./discount_grep.txt:274:./api/test.js:15:      hasSupabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
./discount_grep.txt:275:./api/test.js:24:        hasSupabaseUrl: !!process.env.SUPABASE_URL,
./discount_grep.txt:276:./api/test.js:25:        hasSupabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
./discount_grep.txt:277:./api/orders.js:4:  process.env.SUPABASE_URL,
./discount_grep.txt:278:./api/orders.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./discount_grep.txt:279:./api/orders.js:38:      discount_code,
./discount_grep.txt:280:./api/orders.js:39:      discount_amount = 0,
./discount_grep.txt:281:./api/orders.js:52:    // Calculate original total (before discount)
./discount_grep.txt:282:./api/orders.js:53:    const original_total = discount_amount > 0 ? subtotal + shipping + tax : total;
./discount_grep.txt:283:./api/orders.js:67:        discount_code,
./discount_grep.txt:284:./api/orders.js:68:        discount_amount,
./discount_grep.txt:285:./api/admin/dashboard-stats.js:4:const supabaseUrl = process.env.VITE_SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./discount_grep.txt:286:./api/admin/dashboard-stats.js:5:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./discount_grep.txt:287:./api/admin/dashboard-stats.js:6:const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./discount_grep.txt:288:./api/admin/dashboard-stats.js:9:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:289:./api/admin/dashboard-stats.js:66:    // Get total discount codes
./discount_grep.txt:290:./api/admin/dashboard-stats.js:68:      .from('discount_codes')
./discount_grep.txt:291:./api/admin/dashboard-stats.js:71:    // Get active discount codes
./discount_grep.txt:292:./api/admin/dashboard-stats.js:73:      .from('discount_codes')
./discount_grep.txt:293:./api/admin/dashboard-stats.js:82:      .from('discount_code_usage')
./discount_grep.txt:294:./api/admin/dashboard-stats.js:88:      .from('discount_code_usage')
./discount_grep.txt:295:./api/admin/dashboard-stats.js:89:      .select('discount_amount');
./discount_grep.txt:296:./api/admin/dashboard-stats.js:92:      sum + parseFloat(usage.discount_amount), 0) || 0;
./discount_grep.txt:297:./api/admin/orders.js:4:  process.env.SUPABASE_URL,
./discount_grep.txt:298:./api/admin/orders.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./discount_grep.txt:299:./api/admin/orders.js:80:          total_discounts: 0
./discount_grep.txt:300:./api/admin/orders.js:99:        discount_code,
./discount_grep.txt:301:./api/admin/orders.js:100:        discount_amount,
./discount_grep.txt:302:./api/admin/discount-codes.js:4:const supabaseUrl = process.env.SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./discount_grep.txt:303:./api/admin/discount-codes.js:5:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./discount_grep.txt:304:./api/admin/discount-codes.js:6:const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./discount_grep.txt:305:./api/admin/discount-codes.js:15:  console.error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:306:./api/admin/discount-codes.js:16:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:307:./api/admin/discount-codes.js:70:      // Get all discount codes
./discount_grep.txt:308:./api/admin/discount-codes.js:72:        .from('discount_codes')
./discount_grep.txt:309:./api/admin/discount-codes.js:83:      // Create new discount code
./discount_grep.txt:310:./api/admin/discount-codes.js:88:        discount_type,
./discount_grep.txt:311:./api/admin/discount-codes.js:89:        discount_value,
./discount_grep.txt:312:./api/admin/discount-codes.js:91:        maximum_discount_amount,
./discount_grep.txt:313:./api/admin/discount-codes.js:99:      if (!code || !discount_type || !discount_value) {
./discount_grep.txt:314:./api/admin/discount-codes.js:101:          error: 'Code, discount_type, and discount_value are required' 
./discount_grep.txt:315:./api/admin/discount-codes.js:106:        .from('discount_codes')
./discount_grep.txt:316:./api/admin/discount-codes.js:111:          discount_type,
./discount_grep.txt:317:./api/admin/discount-codes.js:112:          discount_value,
./discount_grep.txt:318:./api/admin/discount-codes.js:114:          maximum_discount_amount,
./discount_grep.txt:319:./api/admin/discount-codes.js:126:          return res.status(400).json({ error: 'Discount code already exists' });
./discount_grep.txt:320:./api/admin/discount-codes.js:134:      // Update discount code (expecting ID in URL path or body)
./discount_grep.txt:321:./api/admin/discount-codes.js:146:        .from('discount_codes')
./discount_grep.txt:322:./api/admin/discount-codes.js:157:        return res.status(404).json({ error: 'Discount code not found' });
./discount_grep.txt:323:./api/admin/discount-codes.js:163:      // Delete discount code (expecting ID in URL query or body)
./discount_grep.txt:324:./api/admin/discount-codes.js:171:        .from('discount_codes')
./discount_grep.txt:325:./api/admin/discount-codes.js:183:        return res.status(404).json({ error: 'Discount code not found' });
./discount_grep.txt:326:./api/admin/discount-codes.js:186:      return res.json({ success: true, message: 'Discount code deleted successfully', data });
./discount_grep.txt:327:./api/admin/discount-codes.js:193:    console.error('Discount codes API error:', error);
./discount_grep.txt:328:./api/send-order-emails.js:18:    const resendApiKey = process.env.VITE_RESEND_API_KEY;
./discount_grep.txt:329:./api/validate-discount.js:4:  process.env.SUPABASE_URL,
./discount_grep.txt:330:./api/validate-discount.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./discount_grep.txt:331:./api/validate-discount.js:27:        error: 'Discount code is required'
./discount_grep.txt:332:./api/validate-discount.js:31:    // Call the database function to validate the discount code
./discount_grep.txt:333:./api/validate-discount.js:33:      .rpc('validate_discount_code', {
./discount_grep.txt:334:./api/validate-discount.js:42:        error: 'Failed to validate discount code'
./discount_grep.txt:335:./api/validate-discount.js:52:          error: 'Invalid discount code'
./discount_grep.txt:336:./api/validate-discount.js:63:      discount_type: result.discount_type,
./discount_grep.txt:337:./api/validate-discount.js:64:      discount_value: result.discount_value,
./discount_grep.txt:338:./api/validate-discount.js:65:      discount_amount: result.discount_amount,
./discount_grep.txt:339:./api/validate-discount.js:68:      savings: result.discount_amount,
./discount_grep.txt:340:./api/validate-discount.js:77:    console.error('Validate discount error:', error);
./discount_grep.txt:341:./.env.example:2:VITE_RESEND_API_KEY=your_resend_api_key_here
./discount_grep.txt:342:./.env.example:5:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:343:./.env.example:6:VITE_SUPABASE_ANON_KEY=your_supabase_anon_key_here
./discount_grep.txt:344:./.env.example:10:SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key_here
./discount_grep.txt:345:./.git/COMMIT_EDITMSG:8:- WELCOME10 discount code for new users
./discount_grep.txt:346:./INTEGRATION_GUIDE.md:1:# Integration Guide: Adding Discount Codes to Checkout
./discount_grep.txt:347:./INTEGRATION_GUIDE.md:3:This guide shows how to integrate the discount code system with your existing AlphaPrint and Silverback checkout forms.
./discount_grep.txt:348:./INTEGRATION_GUIDE.md:12:import orderService, { DiscountValidation } from '@/services/orderService';
./discount_grep.txt:349:./INTEGRATION_GUIDE.md:20:const [discountCode, setDiscountCode] = useState('');
./discount_grep.txt:350:./INTEGRATION_GUIDE.md:21:const [discountValidation, setDiscountValidation] = useState<DiscountValidation | null>(null);
./discount_grep.txt:351:./INTEGRATION_GUIDE.md:22:const [validatingDiscount, setValidatingDiscount] = useState(false);
./discount_grep.txt:352:./INTEGRATION_GUIDE.md:23:const [discountError, setDiscountError] = useState('');
./discount_grep.txt:353:./INTEGRATION_GUIDE.md:28:### Add Discount Code Input
./discount_grep.txt:354:./INTEGRATION_GUIDE.md:33:{/* Discount Code Section */}
./discount_grep.txt:355:./INTEGRATION_GUIDE.md:36:    <CardTitle className="text-lg">Discount Code</CardTitle>
./discount_grep.txt:356:./INTEGRATION_GUIDE.md:37:    <CardDescription>Enter a valid discount code to save money</CardDescription>
./discount_grep.txt:357:./INTEGRATION_GUIDE.md:42:        placeholder="Enter discount code"
./discount_grep.txt:358:./INTEGRATION_GUIDE.md:43:        value={discountCode}
./discount_grep.txt:359:./INTEGRATION_GUIDE.md:44:        onChange={(e) => setDiscountCode(e.target.value.toUpperCase())}
./discount_grep.txt:360:./INTEGRATION_GUIDE.md:45:        disabled={validatingDiscount}
./discount_grep.txt:361:./INTEGRATION_GUIDE.md:50:        onClick={handleValidateDiscount}
./discount_grep.txt:362:./INTEGRATION_GUIDE.md:51:        disabled={!discountCode || validatingDiscount}
./discount_grep.txt:363:./INTEGRATION_GUIDE.md:53:        {validatingDiscount ? (
./discount_grep.txt:364:./INTEGRATION_GUIDE.md:64:    {discountError && (
./discount_grep.txt:365:./INTEGRATION_GUIDE.md:66:        <AlertDescription>{discountError}</AlertDescription>
./discount_grep.txt:366:./INTEGRATION_GUIDE.md:70:    {discountValidation?.valid && (
./discount_grep.txt:367:./INTEGRATION_GUIDE.md:74:          <strong>{discountValidation.name}</strong> applied! 
./discount_grep.txt:368:./INTEGRATION_GUIDE.md:75:          You save {discountValidation.discount_type === 'percentage' 
./discount_grep.txt:369:./INTEGRATION_GUIDE.md:76:            ? `${discountValidation.discount_value}%` 
./discount_grep.txt:370:./INTEGRATION_GUIDE.md:77:            : `€${discountValidation.discount_amount}`}
./discount_grep.txt:371:./INTEGRATION_GUIDE.md:82:            onClick={handleRemoveDiscount}
./discount_grep.txt:372:./INTEGRATION_GUIDE.md:96:const handleValidateDiscount = async () => {
./discount_grep.txt:373:./INTEGRATION_GUIDE.md:97:  if (!discountCode.trim()) return;
./discount_grep.txt:374:./INTEGRATION_GUIDE.md:99:  setValidatingDiscount(true);
./discount_grep.txt:375:./INTEGRATION_GUIDE.md:100:  setDiscountError('');
./discount_grep.txt:376:./INTEGRATION_GUIDE.md:102:  const validation = await orderService.validateDiscountCode(
./discount_grep.txt:377:./INTEGRATION_GUIDE.md:103:    discountCode,
./discount_grep.txt:378:./INTEGRATION_GUIDE.md:109:    setDiscountValidation(validation);
./discount_grep.txt:379:./INTEGRATION_GUIDE.md:110:    setDiscountError('');
./discount_grep.txt:380:./INTEGRATION_GUIDE.md:112:    setDiscountValidation(null);
./discount_grep.txt:381:./INTEGRATION_GUIDE.md:113:    setDiscountError(validation.error || 'Invalid discount code');
./discount_grep.txt:382:./INTEGRATION_GUIDE.md:116:  setValidatingDiscount(false);
./discount_grep.txt:383:./INTEGRATION_GUIDE.md:119:const handleRemoveDiscount = () => {
./discount_grep.txt:384:./INTEGRATION_GUIDE.md:120:  setDiscountCode('');
./discount_grep.txt:385:./INTEGRATION_GUIDE.md:121:  setDiscountValidation(null);
./discount_grep.txt:386:./INTEGRATION_GUIDE.md:122:  setDiscountError('');
./discount_grep.txt:387:./INTEGRATION_GUIDE.md:128:Update your order summary to show discount:
./discount_grep.txt:388:./INTEGRATION_GUIDE.md:144:  {/* Discount */}
./discount_grep.txt:389:./INTEGRATION_GUIDE.md:145:  {discountValidation?.valid && (
./discount_grep.txt:390:./INTEGRATION_GUIDE.md:148:        Discount ({discountValidation.code}):
./discount_grep.txt:391:./INTEGRATION_GUIDE.md:151:        -€{discountValidation.discount_amount?.toFixed(2)}
./discount_grep.txt:392:./INTEGRATION_GUIDE.md:179:// Calculate totals with discount
./discount_grep.txt:393:./INTEGRATION_GUIDE.md:185:const discountAmount = discountValidation?.discount_amount || 0;
./discount_grep.txt:394:./INTEGRATION_GUIDE.md:186:const discountedSubtotal = Math.max(0, subtotalAmount - discountAmount);
./discount_grep.txt:395:./INTEGRATION_GUIDE.md:187:const finalTotal = discountedSubtotal + shippingCost;
./discount_grep.txt:396:./INTEGRATION_GUIDE.md:194:When creating the payment intent, include discount information:
./discount_grep.txt:397:./INTEGRATION_GUIDE.md:202:  discountCode: discountValidation?.code,
./discount_grep.txt:398:./INTEGRATION_GUIDE.md:203:  discountAmount: discountValidation?.discount_amount || 0,
./discount_grep.txt:399:./INTEGRATION_GUIDE.md:210:After successful payment, create the order with discount:
./discount_grep.txt:400:./INTEGRATION_GUIDE.md:233:  discount_code: discountValidation?.code,
./discount_grep.txt:401:./INTEGRATION_GUIDE.md:253:import orderService, { DiscountValidation } from '@/services/orderService';
./discount_grep.txt:402:./INTEGRATION_GUIDE.md:256:  const [discountCode, setDiscountCode] = useState('');
./discount_grep.txt:403:./INTEGRATION_GUIDE.md:257:  const [discountValidation, setDiscountValidation] = useState<DiscountValidation | null>(null);
./discount_grep.txt:404:./INTEGRATION_GUIDE.md:261:  const handleValidateDiscount = async () => {
./discount_grep.txt:405:./INTEGRATION_GUIDE.md:262:    if (!discountCode.trim()) return;
./discount_grep.txt:406:./INTEGRATION_GUIDE.md:264:    const validation = await orderService.validateDiscountCode(
./discount_grep.txt:407:./INTEGRATION_GUIDE.md:265:      discountCode,
./discount_grep.txt:408:./INTEGRATION_GUIDE.md:271:      setDiscountValidation(validation);
./discount_grep.txt:409:./INTEGRATION_GUIDE.md:280:    const discountAmount = discountValidation?.discount_amount || 0;
./discount_grep.txt:410:./INTEGRATION_GUIDE.md:281:    return Math.max(0, basePrice - discountAmount);
./discount_grep.txt:411:./INTEGRATION_GUIDE.md:297:  const [discountValidation, setDiscountValidation] = useState(null);
./discount_grep.txt:412:./INTEGRATION_GUIDE.md:305:    discountValidation
./discount_grep.txt:413:./INTEGRATION_GUIDE.md:320:SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
./discount_grep.txt:414:./INTEGRATION_GUIDE.md:321:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:415:./INTEGRATION_GUIDE.md:322:VITE_SUPABASE_ANON_KEY=your_anon_key_here
./discount_grep.txt:416:./INTEGRATION_GUIDE.md:336:# Terminal 3: Admin API (for discount codes)
./discount_grep.txt:417:./INTEGRATION_GUIDE.md:343:## 📊 Available Discount Codes
./discount_grep.txt:418:./INTEGRATION_GUIDE.md:360:3. Enter discount code: `WELCOME10`
./discount_grep.txt:419:./INTEGRATION_GUIDE.md:361:4. Verify discount is applied
./discount_grep.txt:420:./INTEGRATION_GUIDE.md:370:- See discount code usage analytics
./discount_grep.txt:421:./INTEGRATION_GUIDE.md:371:- Create/edit/delete discount codes
./discount_grep.txt:422:./INTEGRATION_GUIDE.md:375:This integration provides a complete discount code system that works with both your AlphaPrint custom design flow and regular Silverback product checkout!
./discount_grep.txt:423:./debug_report.md:4:- ❌ **SUPABASE_SERVICE_ROLE_KEY is invalid/expired**
./discount_grep.txt:424:./debug_report.md:11:  "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*&limit=1"
./discount_grep.txt:425:./debug_report.md:23:4. Replace `SUPABASE_SERVICE_ROLE_KEY` in your `.env` file
./discount_grep.txt:426:./debug_report.md:28:- ✅ Admin API: `localhost:3002` (discount codes, orders)  
./discount_grep.txt:427:./debug_report.md:41:# Discount codes (after fixing Supabase key)
./discount_grep.txt:428:./debug_report.md:42:curl http://localhost:3002/api/admin/discount-codes
./discount_grep.txt:429:./debug_report.md:46:- 🔧 **NEEDS FIXING:** Update SUPABASE_SERVICE_ROLE_KEY in .env
./discount_grep.txt:430:./discount_grep.txt:1:./.env.production:3:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./discount_grep.txt:431:./discount_grep.txt:2:./.env.production:6:VITE_STRIPE_PUBLISHABLE_KEY=pk_live_51PDOJERwnR6blBksJj5d1YRS3qullycUda6G48z2ETGJvHd7AvOt061oFLkgWNo6g1c4uNZVOoU64MFDnOeKtjiK00QGDX8qy7
./discount_grep.txt:432:./discount_grep.txt:3:./.env.local:3:VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51RxmfY2KYnpDQ8IOWO0gcvEpdMV1PhiVW77btj56Bm1a9E2XWZkUGP1uOfZFcrFZlT94xoNbWctMuJdAP0J58IOR00clddWmZU
./discount_grep.txt:433:./discount_grep.txt:4:./.env.local:4:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./discount_grep.txt:434:./discount_grep.txt:6:./local-api-server.cjs:63:    const resendApiKey = process.env.VITE_RESEND_API_KEY;
./discount_grep.txt:435:./discount_grep.txt:7:./local-api-server.cjs:263:    console.log(`   RESEND_API_KEY: ${process.env.VITE_RESEND_API_KEY ? '✅ Set' : '❌ Missing'}`);
./discount_grep.txt:436:./discount_grep.txt:8:./ADMIN_SETUP.md:1:# Admin Discount Code Management System
./discount_grep.txt:437:./discount_grep.txt:9:./ADMIN_SETUP.md:3:This document explains how to set up and use the admin system for managing discount codes for both AlphaPrint and Silverback checkout.
./discount_grep.txt:438:./discount_grep.txt:10:./ADMIN_SETUP.md:26:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:439:./discount_grep.txt:11:./ADMIN_SETUP.md:27:VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI
./discount_grep.txt:440:./discount_grep.txt:12:./ADMIN_SETUP.md:31:SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
./discount_grep.txt:441:./discount_grep.txt:13:./ADMIN_SETUP.md:85:- **Discount Code Management**: Create, edit, activate/deactivate, and delete codes
./discount_grep.txt:442:./discount_grep.txt:14:./ADMIN_SETUP.md:88:### Creating Discount Codes
./discount_grep.txt:443:./discount_grep.txt:15:./ADMIN_SETUP.md:96:   - **Value**: Discount value (10 for 10% or 20.00 for €20)
./discount_grep.txt:444:./discount_grep.txt:16:./ADMIN_SETUP.md:103:The system comes with these pre-configured discount codes:
./discount_grep.txt:445:./discount_grep.txt:17:./ADMIN_SETUP.md:117:- `GET /api/admin/discount-codes` - List all discount codes
./discount_grep.txt:446:./discount_grep.txt:18:./ADMIN_SETUP.md:118:- `POST /api/admin/discount-codes` - Create new discount code
./discount_grep.txt:447:./discount_grep.txt:19:./ADMIN_SETUP.md:119:- `PUT /api/admin/discount-codes/:id` - Update discount code
./discount_grep.txt:448:./discount_grep.txt:20:./ADMIN_SETUP.md:120:- `DELETE /api/admin/discount-codes/:id` - Delete discount code
./discount_grep.txt:449:./discount_grep.txt:21:./ADMIN_SETUP.md:121:- `GET /api/admin/discount-usage` - Usage analytics
./discount_grep.txt:450:./discount_grep.txt:22:./ADMIN_SETUP.md:125:- `POST /api/validate-discount` - Validate a discount code
./discount_grep.txt:451:./discount_grep.txt:23:./ADMIN_SETUP.md:126:- `POST /api/apply-discount` - Apply and record discount usage
./discount_grep.txt:452:./discount_grep.txt:24:./ADMIN_SETUP.md:132:You can validate discount codes from your checkout forms:
./discount_grep.txt:453:./discount_grep.txt:25:./ADMIN_SETUP.md:135:// Validate discount code
./discount_grep.txt:454:./discount_grep.txt:26:./ADMIN_SETUP.md:136:const response = await fetch('http://localhost:3002/api/validate-discount', {
./discount_grep.txt:455:./discount_grep.txt:27:./ADMIN_SETUP.md:151:  console.log('Discount applied:', result.validation);
./discount_grep.txt:456:./discount_grep.txt:28:./ADMIN_SETUP.md:152:  // Apply discount to order
./discount_grep.txt:457:./discount_grep.txt:29:./ADMIN_SETUP.md:161:// After successful payment, record the discount usage
./discount_grep.txt:458:./discount_grep.txt:30:./ADMIN_SETUP.md:162:await fetch('http://localhost:3002/api/apply-discount', {
./discount_grep.txt:459:./discount_grep.txt:31:./ADMIN_SETUP.md:171:    discountAmount: 20.00,
./discount_grep.txt:460:./discount_grep.txt:32:./ADMIN_SETUP.md:201:- `discount_codes` - Stores all discount codes
./discount_grep.txt:461:./discount_grep.txt:33:./ADMIN_SETUP.md:202:- `discount_code_usage` - Tracks usage for analytics
./discount_grep.txt:462:./discount_grep.txt:34:./ADMIN_SETUP.md:211:1. **"Authentication failed"** - Check that SUPABASE_SERVICE_ROLE_KEY is correct
./discount_grep.txt:463:./discount_grep.txt:35:./DISCOUNT_CODE_ANALYSIS.md:1:# 🎫 COMPLETE DISCOUNT CODE API ANALYSIS
./discount_grep.txt:464:./discount_grep.txt:36:./DISCOUNT_CODE_ANALYSIS.md:3:## **📁 ALL DISCOUNT-RELATED FILES:**
./discount_grep.txt:465:./discount_grep.txt:37:./DISCOUNT_CODE_ANALYSIS.md:7:supabase/migrations/20250829135300_create_discount_codes_table.sql
./discount_grep.txt:466:./discount_grep.txt:38:./DISCOUNT_CODE_ANALYSIS.md:14:api/admin/discount-codes.js - Serverless discount codes endpoint  
./discount_grep.txt:467:./discount_grep.txt:39:./DISCOUNT_CODE_ANALYSIS.md:15:api/validate-discount.js - Public discount validation endpoint
./discount_grep.txt:468:./discount_grep.txt:40:./DISCOUNT_CODE_ANALYSIS.md:16:api/orders.js - Order creation with discount support
./discount_grep.txt:469:./discount_grep.txt:41:./DISCOUNT_CODE_ANALYSIS.md:18:api/admin/dashboard-stats.js - Dashboard stats with discount metrics
./discount_grep.txt:470:./discount_grep.txt:42:./DISCOUNT_CODE_ANALYSIS.md:23:src/pages/AdminDashboard.tsx - Admin discount management interface
./discount_grep.txt:471:./discount_grep.txt:43:./DISCOUNT_CODE_ANALYSIS.md:24:src/pages/AlphaPrintStart.tsx - Discount application in print flow
./discount_grep.txt:472:./discount_grep.txt:44:./DISCOUNT_CODE_ANALYSIS.md:25:src/pages/AlphaPrintQuote.tsx - Quote with discount calculation
./discount_grep.txt:473:./discount_grep.txt:45:./DISCOUNT_CODE_ANALYSIS.md:26:src/services/orderService.ts - Order service with discount handling
./discount_grep.txt:474:./discount_grep.txt:46:./DISCOUNT_CODE_ANALYSIS.md:40:- `api/admin/discount-codes.js` (Vercel serverless function)
./discount_grep.txt:475:./discount_grep.txt:47:./DISCOUNT_CODE_ANALYSIS.md:46:curl -s "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*&limit=1"
./discount_grep.txt:476:./discount_grep.txt:48:./DISCOUNT_CODE_ANALYSIS.md:66:// Get all discount codes (admin only) - temporarily bypass auth for testing
./discount_grep.txt:477:./discount_grep.txt:49:./DISCOUNT_CODE_ANALYSIS.md:67:app.get('/api/admin/discount-codes', async (req, res) => {
./discount_grep.txt:478:./discount_grep.txt:50:./DISCOUNT_CODE_ANALYSIS.md:70:      .from('discount_codes')
./discount_grep.txt:479:./discount_grep.txt:51:./DISCOUNT_CODE_ANALYSIS.md:80:    console.error('Get discount codes error:', error);
./discount_grep.txt:480:./discount_grep.txt:52:./DISCOUNT_CODE_ANALYSIS.md:81:    res.status(500).json({ error: 'Failed to fetch discount codes' });
./discount_grep.txt:481:./discount_grep.txt:53:./DISCOUNT_CODE_ANALYSIS.md:88:const fetchDiscountCodes = async () => {
./discount_grep.txt:482:./discount_grep.txt:54:./DISCOUNT_CODE_ANALYSIS.md:99:    const codesUrl = getApiUrl('/api/admin/discount-codes');
./discount_grep.txt:483:./discount_grep.txt:55:./DISCOUNT_CODE_ANALYSIS.md:111:2. **discount_codes Table Missing/Inaccessible** - RLS policies blocking access
./discount_grep.txt:484:./discount_grep.txt:56:./DISCOUNT_CODE_ANALYSIS.md:120:CREATE TABLE IF NOT EXISTS discount_codes (
./discount_grep.txt:485:./discount_grep.txt:57:./DISCOUNT_CODE_ANALYSIS.md:125:  discount_type VARCHAR(20) CHECK (discount_type IN ('percentage', 'fixed_amount')) NOT NULL,
./discount_grep.txt:486:./discount_grep.txt:58:./DISCOUNT_CODE_ANALYSIS.md:126:  discount_value DECIMAL(10,2) NOT NULL,
./discount_grep.txt:487:./discount_grep.txt:59:./DISCOUNT_CODE_ANALYSIS.md:128:  maximum_discount_amount DECIMAL(10,2),
./discount_grep.txt:488:./discount_grep.txt:60:./DISCOUNT_CODE_ANALYSIS.md:140:ALTER TABLE discount_codes ENABLE ROW LEVEL SECURITY;
./discount_grep.txt:489:./discount_grep.txt:61:./DISCOUNT_CODE_ANALYSIS.md:143:CREATE POLICY "Admin can manage discount codes" ON discount_codes
./discount_grep.txt:490:./discount_grep.txt:62:./DISCOUNT_CODE_ANALYSIS.md:149:CREATE POLICY "Service role full access" ON discount_codes
./discount_grep.txt:491:./discount_grep.txt:63:./DISCOUNT_CODE_ANALYSIS.md:158:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:492:./discount_grep.txt:64:./DISCOUNT_CODE_ANALYSIS.md:159:VITE_SUPABASE_ANON_KEY=<your_actual_anon_key>
./discount_grep.txt:493:./discount_grep.txt:65:./DISCOUNT_CODE_ANALYSIS.md:160:SUPABASE_SERVICE_ROLE_KEY=<your_actual_service_role_key>
./discount_grep.txt:494:./discount_grep.txt:66:./DISCOUNT_CODE_ANALYSIS.md:168:     "https://iteixoxyyjhrskrkuuuc.supabase.co/rest/v1/discount_codes?select=*"
./discount_grep.txt:495:./discount_grep.txt:67:./DISCOUNT_CODE_ANALYSIS.md:175:curl http://localhost:3002/api/admin/discount-codes
./discount_grep.txt:496:./discount_grep.txt:68:./supabase/migrations/20250829135300_create_discount_codes_table.sql:1:-- Create discount_codes table for managing discount codes
./discount_grep.txt:497:./discount_grep.txt:69:./supabase/migrations/20250829135300_create_discount_codes_table.sql:2:CREATE TABLE public.discount_codes (
./discount_grep.txt:498:./discount_grep.txt:70:./supabase/migrations/20250829135300_create_discount_codes_table.sql:7:  discount_type TEXT NOT NULL CHECK (discount_type IN ('percentage', 'fixed_amount')),
./discount_grep.txt:499:./discount_grep.txt:71:./supabase/migrations/20250829135300_create_discount_codes_table.sql:8:  discount_value DECIMAL(10,2) NOT NULL CHECK (discount_value > 0),
./discount_grep.txt:500:./discount_grep.txt:72:./supabase/migrations/20250829135300_create_discount_codes_table.sql:10:  maximum_discount_amount DECIMAL(10,2) CHECK (maximum_discount_amount IS NULL OR maximum_discount_amount > 0),
./discount_grep.txt:501:./discount_grep.txt:73:./supabase/migrations/20250829135300_create_discount_codes_table.sql:25:CREATE INDEX idx_discount_codes_code ON public.discount_codes (code);
./discount_grep.txt:502:./discount_grep.txt:74:./supabase/migrations/20250829135300_create_discount_codes_table.sql:26:CREATE INDEX idx_discount_codes_is_active ON public.discount_codes (is_active);
./discount_grep.txt:503:./discount_grep.txt:75:./supabase/migrations/20250829135300_create_discount_codes_table.sql:27:CREATE INDEX idx_discount_codes_valid_dates ON public.discount_codes (valid_from, valid_until);
./discount_grep.txt:504:./discount_grep.txt:76:./supabase/migrations/20250829135300_create_discount_codes_table.sql:28:CREATE INDEX idx_discount_codes_created_at ON public.discount_codes (created_at DESC);
./discount_grep.txt:505:./discount_grep.txt:77:./supabase/migrations/20250829135300_create_discount_codes_table.sql:31:ALTER TABLE public.discount_codes ENABLE ROW LEVEL SECURITY;
./discount_grep.txt:506:./discount_grep.txt:78:./supabase/migrations/20250829135300_create_discount_codes_table.sql:33:-- RLS Policies for discount codes
./discount_grep.txt:507:./discount_grep.txt:79:./supabase/migrations/20250829135300_create_discount_codes_table.sql:34:-- Public can view active discount codes for validation
./discount_grep.txt:508:./discount_grep.txt:80:./supabase/migrations/20250829135300_create_discount_codes_table.sql:35:CREATE POLICY "Active discount codes are viewable by everyone" ON public.discount_codes
./discount_grep.txt:509:./discount_grep.txt:81:./supabase/migrations/20250829135300_create_discount_codes_table.sql:38:-- Admin can view all discount codes
./discount_grep.txt:510:./discount_grep.txt:82:./supabase/migrations/20250829135300_create_discount_codes_table.sql:39:CREATE POLICY "Admin can view all discount codes" ON public.discount_codes
./discount_grep.txt:511:./discount_grep.txt:83:./supabase/migrations/20250829135300_create_discount_codes_table.sql:48:-- Admin can insert discount codes
./discount_grep.txt:512:./discount_grep.txt:84:./supabase/migrations/20250829135300_create_discount_codes_table.sql:49:CREATE POLICY "Admin can insert discount codes" ON public.discount_codes
./discount_grep.txt:513:./discount_grep.txt:85:./supabase/migrations/20250829135300_create_discount_codes_table.sql:58:-- Admin can update discount codes
./discount_grep.txt:514:./discount_grep.txt:86:./supabase/migrations/20250829135300_create_discount_codes_table.sql:59:CREATE POLICY "Admin can update discount codes" ON public.discount_codes
./discount_grep.txt:515:./discount_grep.txt:87:./supabase/migrations/20250829135300_create_discount_codes_table.sql:68:-- Admin can delete discount codes
./discount_grep.txt:516:./discount_grep.txt:88:./supabase/migrations/20250829135300_create_discount_codes_table.sql:69:CREATE POLICY "Admin can delete discount codes" ON public.discount_codes
./discount_grep.txt:517:./discount_grep.txt:89:./supabase/migrations/20250829135300_create_discount_codes_table.sql:79:CREATE TRIGGER update_discount_codes_updated_at
./discount_grep.txt:518:./discount_grep.txt:90:./supabase/migrations/20250829135300_create_discount_codes_table.sql:80:  BEFORE UPDATE ON public.discount_codes
./discount_grep.txt:519:./discount_grep.txt:91:./supabase/migrations/20250829135300_create_discount_codes_table.sql:84:-- Insert some sample discount codes for testing (optional)
./discount_grep.txt:520:./discount_grep.txt:92:./supabase/migrations/20250829135300_create_discount_codes_table.sql:85:INSERT INTO public.discount_codes (code, name, description, discount_type, discount_value, minimum_order_amount, is_active) VALUES
./discount_grep.txt:521:./discount_grep.txt:93:./supabase/migrations/20250829135300_create_discount_codes_table.sql:90:-- Create function to validate and use discount codes
./discount_grep.txt:522:./discount_grep.txt:94:./supabase/migrations/20250829135300_create_discount_codes_table.sql:91:CREATE OR REPLACE FUNCTION validate_discount_code(
./discount_grep.txt:523:./discount_grep.txt:95:./supabase/migrations/20250829135300_create_discount_codes_table.sql:98:  discount_id UUID,
./discount_grep.txt:524:./discount_grep.txt:96:./supabase/migrations/20250829135300_create_discount_codes_table.sql:102:  discount_type TEXT,
./discount_grep.txt:525:./discount_grep.txt:97:./supabase/migrations/20250829135300_create_discount_codes_table.sql:103:  discount_value DECIMAL,
./discount_grep.txt:526:./discount_grep.txt:98:./supabase/migrations/20250829135300_create_discount_codes_table.sql:104:  discount_amount DECIMAL,
./discount_grep.txt:527:./discount_grep.txt:99:./supabase/migrations/20250829135300_create_discount_codes_table.sql:109:  v_discount public.discount_codes%ROWTYPE;
./discount_grep.txt:528:./discount_grep.txt:100:./supabase/migrations/20250829135300_create_discount_codes_table.sql:110:  v_discount_amount DECIMAL;
./discount_grep.txt:529:./discount_grep.txt:101:./supabase/migrations/20250829135300_create_discount_codes_table.sql:113:  -- Find the discount code
./discount_grep.txt:530:./discount_grep.txt:102:./supabase/migrations/20250829135300_create_discount_codes_table.sql:114:  SELECT * INTO v_discount 
./discount_grep.txt:531:./discount_grep.txt:103:./supabase/migrations/20250829135300_create_discount_codes_table.sql:115:  FROM public.discount_codes 
./discount_grep.txt:532:./discount_grep.txt:104:./supabase/migrations/20250829135300_create_discount_codes_table.sql:116:  WHERE UPPER(discount_codes.code) = UPPER(p_code)
./discount_grep.txt:533:./discount_grep.txt:105:./supabase/migrations/20250829135300_create_discount_codes_table.sql:121:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Invalid discount code';
./discount_grep.txt:534:./discount_grep.txt:106:./supabase/migrations/20250829135300_create_discount_codes_table.sql:126:  IF (v_discount.valid_from IS NOT NULL AND v_discount.valid_from > now()) OR
./discount_grep.txt:535:./discount_grep.txt:107:./supabase/migrations/20250829135300_create_discount_codes_table.sql:127:     (v_discount.valid_until IS NOT NULL AND v_discount.valid_until < now()) THEN
./discount_grep.txt:536:./discount_grep.txt:108:./supabase/migrations/20250829135300_create_discount_codes_table.sql:128:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Discount code has expired or is not yet valid';
./discount_grep.txt:537:./discount_grep.txt:109:./supabase/migrations/20250829135300_create_discount_codes_table.sql:133:  IF v_discount.usage_limit IS NOT NULL AND v_discount.used_count >= v_discount.usage_limit THEN
./discount_grep.txt:538:./discount_grep.txt:110:./supabase/migrations/20250829135300_create_discount_codes_table.sql:134:    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::DECIMAL, NULL::DECIMAL, p_order_amount, 'Discount code usage limit exceeded';
./discount_grep.txt:539:./discount_grep.txt:111:./supabase/migrations/20250829135300_create_discount_codes_table.sql:139:  IF p_order_amount IS NOT NULL AND p_order_amount < v_discount.minimum_order_amount THEN
./discount_grep.txt:540:./discount_grep.txt:112:./supabase/migrations/20250829135300_create_discount_codes_table.sql:141:      format('Minimum order amount of €%.2f required', v_discount.minimum_order_amount);
./discount_grep.txt:541:./discount_grep.txt:113:./supabase/migrations/20250829135300_create_discount_codes_table.sql:145:  -- Calculate discount amount
./discount_grep.txt:542:./discount_grep.txt:114:./supabase/migrations/20250829135300_create_discount_codes_table.sql:146:  IF v_discount.discount_type = 'percentage' THEN
./discount_grep.txt:543:./discount_grep.txt:115:./supabase/migrations/20250829135300_create_discount_codes_table.sql:147:    v_discount_amount := (p_order_amount * v_discount.discount_value / 100);
./discount_grep.txt:544:./discount_grep.txt:116:./supabase/migrations/20250829135300_create_discount_codes_table.sql:148:    -- Apply maximum discount limit if set
./discount_grep.txt:545:./discount_grep.txt:117:./supabase/migrations/20250829135300_create_discount_codes_table.sql:149:    IF v_discount.maximum_discount_amount IS NOT NULL THEN
./discount_grep.txt:546:./discount_grep.txt:118:./supabase/migrations/20250829135300_create_discount_codes_table.sql:150:      v_discount_amount := LEAST(v_discount_amount, v_discount.maximum_discount_amount);
./discount_grep.txt:547:./discount_grep.txt:119:./supabase/migrations/20250829135300_create_discount_codes_table.sql:153:    v_discount_amount := v_discount.discount_value;
./discount_grep.txt:548:./discount_grep.txt:120:./supabase/migrations/20250829135300_create_discount_codes_table.sql:157:  v_final_amount := GREATEST(0, COALESCE(p_order_amount, 0) - v_discount_amount);
./discount_grep.txt:549:./discount_grep.txt:121:./supabase/migrations/20250829135300_create_discount_codes_table.sql:159:  -- Return valid discount
./discount_grep.txt:550:./discount_grep.txt:122:./supabase/migrations/20250829135300_create_discount_codes_table.sql:162:    v_discount.id,
./discount_grep.txt:551:./discount_grep.txt:123:./supabase/migrations/20250829135300_create_discount_codes_table.sql:163:    v_discount.code,
./discount_grep.txt:552:./discount_grep.txt:124:./supabase/migrations/20250829135300_create_discount_codes_table.sql:164:    v_discount.name,
./discount_grep.txt:553:./discount_grep.txt:125:./supabase/migrations/20250829135300_create_discount_codes_table.sql:165:    v_discount.description,
./discount_grep.txt:554:./discount_grep.txt:126:./supabase/migrations/20250829135300_create_discount_codes_table.sql:166:    v_discount.discount_type,
./discount_grep.txt:555:./discount_grep.txt:127:./supabase/migrations/20250829135300_create_discount_codes_table.sql:167:    v_discount.discount_value,
./discount_grep.txt:556:./discount_grep.txt:128:./supabase/migrations/20250829135300_create_discount_codes_table.sql:168:    v_discount_amount,
./discount_grep.txt:557:./discount_grep.txt:129:./supabase/migrations/20250829135300_create_discount_codes_table.sql:175:CREATE OR REPLACE FUNCTION increment_discount_usage(p_discount_id UUID)
./discount_grep.txt:558:./discount_grep.txt:130:./supabase/migrations/20250829135300_create_discount_codes_table.sql:178:  UPDATE public.discount_codes 
./discount_grep.txt:559:./discount_grep.txt:131:./supabase/migrations/20250829135300_create_discount_codes_table.sql:181:  WHERE id = p_discount_id;
./discount_grep.txt:560:./discount_grep.txt:132:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:6:ADD COLUMN discount_code TEXT,
./discount_grep.txt:561:./discount_grep.txt:133:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:7:ADD COLUMN discount_amount DECIMAL(10,2) DEFAULT 0;
./discount_grep.txt:562:./discount_grep.txt:134:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:12:-- Add index for discount code analytics
./discount_grep.txt:563:./discount_grep.txt:135:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:13:CREATE INDEX idx_orders_discount_code ON public.orders (discount_code);
./discount_grep.txt:564:./discount_grep.txt:136:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:54:  total_discounts DECIMAL
./discount_grep.txt:565:./discount_grep.txt:137:./supabase/migrations/20250829132500_add_stripe_payment_fields.sql:75:    COALESCE(SUM(discount_amount), 0)::DECIMAL as total_discounts
./discount_grep.txt:566:./discount_grep.txt:138:./package-lock.json:2:  "name": "vite_react_shadcn_ts",
./discount_grep.txt:567:./discount_grep.txt:139:./package-lock.json:8:      "name": "vite_react_shadcn_ts",
./discount_grep.txt:568:./discount_grep.txt:140:./package.json:2:  "name": "vite_react_shadcn_ts",
./discount_grep.txt:569:./discount_grep.txt:141:./.env:2:VITE_RESEND_API_KEY=re_eLDYNW9u_8XTPYc49fii7yuntHWCoZsYq
./discount_grep.txt:570:./discount_grep.txt:142:./.env:6:VITE_STRIPE_PUBLISHABLE_KEY=pk_live_51PDOJERwnR6blBksJj5d1YRS3qullycUda6G48z2ETGJvHd7AvOt061oFLkgWNo6g1c4uNZVOoU64MFDnOeKtjiK00QGDX8qy7
./discount_grep.txt:571:./discount_grep.txt:143:./.env:10:# VITE_STRIPE_PUBLISHABLE_KEY=pk_test_51RxmfY2KYnpDQ8IOWO0gcvEpdMV1PhiVW77btj56Bm1a9E2XWZkUGP1uOfZFcrFZlT94xoNbWctMuJdAP0J58IOR00clddWmZU
./discount_grep.txt:572:./discount_grep.txt:144:./.env:14:VITE_SUPABASE_URL=https://iteixoxyyjhrskrkuuuc.supabase.co
./discount_grep.txt:573:./discount_grep.txt:145:./.env:15:VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI
./discount_grep.txt:574:./discount_grep.txt:146:./.env:16:SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTM3MzEzNiwiZXhwIjoyMDcwOTQ5MTM2fQ.1aOdVqBHXMlGDlL1M4EtV_EkCa5i7PQ9m6B7IxoEPbE
./discount_grep.txt:575:./discount_grep.txt:147:./api/admin-server.cjs:10:const supabaseUrl = process.env.VITE_SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./discount_grep.txt:576:./discount_grep.txt:148:./api/admin-server.cjs:11:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./discount_grep.txt:577:./discount_grep.txt:149:./api/admin-server.cjs:14:  console.error('❌ SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:578:./discount_grep.txt:150:./api/admin-server.cjs:15:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:579:./discount_grep.txt:151:./api/admin-server.cjs:46:    const anonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./discount_grep.txt:580:./discount_grep.txt:152:./api/admin-server.cjs:107:// Get all discount codes (admin only) - temporarily bypass auth for testing
./discount_grep.txt:581:./discount_grep.txt:153:./api/admin-server.cjs:108:app.get('/api/admin/discount-codes', async (req, res) => {
./discount_grep.txt:582:./discount_grep.txt:154:./api/admin-server.cjs:111:      .from('discount_codes')
./discount_grep.txt:583:./discount_grep.txt:155:./api/admin-server.cjs:121:    console.error('Get discount codes error:', error);
./discount_grep.txt:584:./discount_grep.txt:156:./api/admin-server.cjs:122:    res.status(500).json({ error: 'Failed to fetch discount codes' });
./discount_grep.txt:585:./discount_grep.txt:157:./api/admin-server.cjs:126:// Create new discount code (admin only)
./discount_grep.txt:586:./discount_grep.txt:158:./api/admin-server.cjs:127:app.post('/api/admin/discount-codes', verifyAdmin, async (req, res) => {
./discount_grep.txt:587:./discount_grep.txt:159:./api/admin-server.cjs:133:      discount_type,
./discount_grep.txt:588:./discount_grep.txt:160:./api/admin-server.cjs:134:      discount_value,
./discount_grep.txt:589:./discount_grep.txt:161:./api/admin-server.cjs:136:      maximum_discount_amount,
./discount_grep.txt:590:./discount_grep.txt:162:./api/admin-server.cjs:144:    if (!code || !discount_type || !discount_value) {
./discount_grep.txt:591:./discount_grep.txt:163:./api/admin-server.cjs:146:        error: 'Code, discount_type, and discount_value are required' 
./discount_grep.txt:592:./discount_grep.txt:164:./api/admin-server.cjs:151:      .from('discount_codes')
./discount_grep.txt:593:./discount_grep.txt:165:./api/admin-server.cjs:156:        discount_type,
./discount_grep.txt:594:./discount_grep.txt:166:./api/admin-server.cjs:157:        discount_value,
./discount_grep.txt:595:./discount_grep.txt:167:./api/admin-server.cjs:159:        maximum_discount_amount,
./discount_grep.txt:596:./discount_grep.txt:168:./api/admin-server.cjs:171:        return res.status(400).json({ error: 'Discount code already exists' });
./discount_grep.txt:597:./discount_grep.txt:169:./api/admin-server.cjs:178:    console.error('Create discount code error:', error);
./discount_grep.txt:598:./discount_grep.txt:170:./api/admin-server.cjs:179:    res.status(500).json({ error: 'Failed to create discount code' });
./discount_grep.txt:599:./discount_grep.txt:171:./api/admin-server.cjs:183:// Update discount code (admin only)
./discount_grep.txt:600:./discount_grep.txt:172:./api/admin-server.cjs:184:app.put('/api/admin/discount-codes/:id', verifyAdmin, async (req, res) => {
./discount_grep.txt:601:./discount_grep.txt:173:./api/admin-server.cjs:195:      .from('discount_codes')
./discount_grep.txt:602:./discount_grep.txt:174:./api/admin-server.cjs:206:      return res.status(404).json({ error: 'Discount code not found' });
./discount_grep.txt:603:./discount_grep.txt:175:./api/admin-server.cjs:211:    console.error('Update discount code error:', error);
./discount_grep.txt:604:./discount_grep.txt:176:./api/admin-server.cjs:212:    res.status(500).json({ error: 'Failed to update discount code' });
./discount_grep.txt:605:./discount_grep.txt:177:./api/admin-server.cjs:216:// Delete discount code (admin only)
./discount_grep.txt:606:./discount_grep.txt:178:./api/admin-server.cjs:217:app.delete('/api/admin/discount-codes/:id', verifyAdmin, async (req, res) => {
./discount_grep.txt:607:./discount_grep.txt:179:./api/admin-server.cjs:222:      .from('discount_codes')
./discount_grep.txt:608:./discount_grep.txt:180:./api/admin-server.cjs:233:      return res.status(404).json({ error: 'Discount code not found' });
./discount_grep.txt:609:./discount_grep.txt:181:./api/admin-server.cjs:236:    res.json({ success: true, message: 'Discount code deleted successfully' });
./discount_grep.txt:610:./discount_grep.txt:182:./api/admin-server.cjs:238:    console.error('Delete discount code error:', error);
./discount_grep.txt:611:./discount_grep.txt:183:./api/admin-server.cjs:239:    res.status(500).json({ error: 'Failed to delete discount code' });
./discount_grep.txt:612:./discount_grep.txt:184:./api/admin-server.cjs:243:// Get discount code usage analytics (admin only)
./discount_grep.txt:613:./discount_grep.txt:185:./api/admin-server.cjs:244:app.get('/api/admin/discount-usage/:codeId', verifyAdmin, async (req, res) => {
./discount_grep.txt:614:./discount_grep.txt:186:./api/admin-server.cjs:249:      .from('discount_code_usage')
./discount_grep.txt:615:./discount_grep.txt:187:./api/admin-server.cjs:252:        discount_codes (
./discount_grep.txt:616:./discount_grep.txt:188:./api/admin-server.cjs:255:          discount_type,
./discount_grep.txt:617:./discount_grep.txt:189:./api/admin-server.cjs:256:          discount_value
./discount_grep.txt:618:./discount_grep.txt:190:./api/admin-server.cjs:262:      query = query.eq('discount_code_id', codeId);
./discount_grep.txt:619:./discount_grep.txt:191:./api/admin-server.cjs:278:// Get all discount code usage analytics (admin only)
./discount_grep.txt:620:./discount_grep.txt:192:./api/admin-server.cjs:279:app.get('/api/admin/discount-usage', verifyAdmin, async (req, res) => {
./discount_grep.txt:621:./discount_grep.txt:193:./api/admin-server.cjs:284:      .from('discount_code_usage')
./discount_grep.txt:622:./discount_grep.txt:194:./api/admin-server.cjs:287:        discount_codes (
./discount_grep.txt:623:./discount_grep.txt:195:./api/admin-server.cjs:290:          discount_type,
./discount_grep.txt:624:./discount_grep.txt:196:./api/admin-server.cjs:291:          discount_value
./discount_grep.txt:625:./discount_grep.txt:197:./api/admin-server.cjs:297:      query = query.eq('discount_code_id', codeId);
./discount_grep.txt:626:./discount_grep.txt:198:./api/admin-server.cjs:313:// Public endpoint to validate discount codes (for frontend checkout)
./discount_grep.txt:627:./discount_grep.txt:199:./api/admin-server.cjs:314:app.post('/api/validate-discount', async (req, res) => {
./discount_grep.txt:628:./discount_grep.txt:200:./api/admin-server.cjs:323:      .rpc('validate_discount_code', {
./discount_grep.txt:629:./discount_grep.txt:201:./api/admin-server.cjs:335:    console.error('Validate discount error:', error);
./discount_grep.txt:630:./discount_grep.txt:202:./api/admin-server.cjs:336:    res.status(500).json({ error: 'Failed to validate discount code' });
./discount_grep.txt:631:./discount_grep.txt:203:./api/admin-server.cjs:340:// Apply discount code (record usage)
./discount_grep.txt:632:./discount_grep.txt:204:./api/admin-server.cjs:341:app.post('/api/apply-discount', async (req, res) => {
./discount_grep.txt:633:./discount_grep.txt:205:./api/admin-server.cjs:343:    const { code, orderId, customerEmail, discountAmount, orderAmount, ipAddress, userAgent } = req.body;
./discount_grep.txt:634:./discount_grep.txt:206:./api/admin-server.cjs:345:    // First get the discount code ID
./discount_grep.txt:635:./discount_grep.txt:207:./api/admin-server.cjs:346:    const { data: discountCode, error: discountError } = await supabase
./discount_grep.txt:636:./discount_grep.txt:208:./api/admin-server.cjs:347:      .from('discount_codes')
./discount_grep.txt:637:./discount_grep.txt:209:./api/admin-server.cjs:352:    if (discountError || !discountCode) {
./discount_grep.txt:638:./discount_grep.txt:210:./api/admin-server.cjs:353:      return res.status(400).json({ error: 'Invalid discount code' });
./discount_grep.txt:639:./discount_grep.txt:211:./api/admin-server.cjs:358:      .from('discount_code_usage')
./discount_grep.txt:640:./discount_grep.txt:212:./api/admin-server.cjs:360:        discount_code_id: discountCode.id,
./discount_grep.txt:641:./discount_grep.txt:213:./api/admin-server.cjs:363:        discount_amount: discountAmount,
./discount_grep.txt:642:./discount_grep.txt:214:./api/admin-server.cjs:377:      .from('discount_codes')
./discount_grep.txt:643:./discount_grep.txt:215:./api/admin-server.cjs:381:      .eq('id', discountCode.id);
./discount_grep.txt:644:./discount_grep.txt:216:./api/admin-server.cjs:389:    console.error('Apply discount error:', error);
./discount_grep.txt:645:./discount_grep.txt:217:./api/admin-server.cjs:390:    res.status(500).json({ error: 'Failed to apply discount code' });
./discount_grep.txt:646:./discount_grep.txt:218:./api/admin-server.cjs:397:    // Get total discount codes
./discount_grep.txt:647:./discount_grep.txt:219:./api/admin-server.cjs:399:      .from('discount_codes')
./discount_grep.txt:648:./discount_grep.txt:220:./api/admin-server.cjs:402:    // Get active discount codes
./discount_grep.txt:649:./discount_grep.txt:221:./api/admin-server.cjs:404:      .from('discount_codes')
./discount_grep.txt:650:./discount_grep.txt:222:./api/admin-server.cjs:413:      .from('discount_code_usage')
./discount_grep.txt:651:./discount_grep.txt:223:./api/admin-server.cjs:419:      .from('discount_code_usage')
./discount_grep.txt:652:./discount_grep.txt:224:./api/admin-server.cjs:420:      .select('discount_amount');
./discount_grep.txt:653:./discount_grep.txt:225:./api/admin-server.cjs:423:      sum + parseFloat(usage.discount_amount), 0) || 0;
./discount_grep.txt:654:./discount_grep.txt:226:./api/admin-server.cjs:473:        discount_codes (
./discount_grep.txt:655:./discount_grep.txt:227:./api/admin-server.cjs:476:          discount_type,
./discount_grep.txt:656:./discount_grep.txt:228:./api/admin-server.cjs:477:          discount_value
./discount_grep.txt:657:./discount_grep.txt:229:./api/admin-server.cjs:509:        discount_codes (
./discount_grep.txt:658:./discount_grep.txt:230:./api/admin-server.cjs:512:          discount_type,
./discount_grep.txt:659:./discount_grep.txt:231:./api/admin-server.cjs:513:          discount_value
./discount_grep.txt:660:./discount_grep.txt:232:./api/admin-server.cjs:541:// Create order with discount validation
./discount_grep.txt:661:./discount_grep.txt:233:./api/admin-server.cjs:550:      discount_code,
./discount_grep.txt:662:./discount_grep.txt:234:./api/admin-server.cjs:555:    let discountCodeData = null;
./discount_grep.txt:663:./discount_grep.txt:235:./api/admin-server.cjs:556:    let discountAmount = 0;
./discount_grep.txt:664:./discount_grep.txt:236:./api/admin-server.cjs:559:    // Validate discount code if provided
./discount_grep.txt:665:./discount_grep.txt:237:./api/admin-server.cjs:560:    if (discount_code) {
./discount_grep.txt:666:./discount_grep.txt:238:./api/admin-server.cjs:562:        .rpc('validate_discount_code', {
./discount_grep.txt:667:./discount_grep.txt:239:./api/admin-server.cjs:563:          p_code: discount_code.toUpperCase(),
./discount_grep.txt:668:./discount_grep.txt:240:./api/admin-server.cjs:570:          error: validation?.error || 'Invalid discount code' 
./discount_grep.txt:669:./discount_grep.txt:241:./api/admin-server.cjs:574:      // Get discount code details
./discount_grep.txt:670:./discount_grep.txt:242:./api/admin-server.cjs:575:      const { data: discountCode, error: dcError } = await supabase
./discount_grep.txt:671:./discount_grep.txt:243:./api/admin-server.cjs:576:        .from('discount_codes')
./discount_grep.txt:672:./discount_grep.txt:244:./api/admin-server.cjs:578:        .eq('code', discount_code.toUpperCase())
./discount_grep.txt:673:./discount_grep.txt:245:./api/admin-server.cjs:581:      if (!dcError && discountCode) {
./discount_grep.txt:674:./discount_grep.txt:246:./api/admin-server.cjs:582:        discountCodeData = discountCode;
./discount_grep.txt:675:./discount_grep.txt:247:./api/admin-server.cjs:583:        discountAmount = validation.discount_amount;
./discount_grep.txt:676:./discount_grep.txt:248:./api/admin-server.cjs:604:        discount_code_id: discountCodeData?.id || null,
./discount_grep.txt:677:./discount_grep.txt:249:./api/admin-server.cjs:605:        discount_code: discount_code || null,
./discount_grep.txt:678:./discount_grep.txt:250:./api/admin-server.cjs:606:        discount_amount,
./discount_grep.txt:679:./discount_grep.txt:251:./api/admin-server.cjs:607:        discount_type: discountCodeData?.discount_type || null,
./discount_grep.txt:680:./discount_grep.txt:252:./api/admin-server.cjs:620:    // Record discount usage if applicable
./discount_grep.txt:681:./discount_grep.txt:253:./api/admin-server.cjs:621:    if (discountCodeData && discountAmount > 0) {
./discount_grep.txt:682:./discount_grep.txt:254:./api/admin-server.cjs:623:        .from('discount_code_usage')
./discount_grep.txt:683:./discount_grep.txt:255:./api/admin-server.cjs:625:          discount_code_id: discountCodeData.id,
./discount_grep.txt:684:./discount_grep.txt:256:./api/admin-server.cjs:628:          discount_amount: discountAmount,
./discount_grep.txt:685:./discount_grep.txt:257:./api/admin-server.cjs:636:        .from('discount_codes')
./discount_grep.txt:686:./discount_grep.txt:258:./api/admin-server.cjs:638:        .eq('id', discountCodeData.id);
./discount_grep.txt:687:./discount_grep.txt:259:./api/admin-server.cjs:736:        discount_amount,
./discount_grep.txt:688:./discount_grep.txt:260:./api/admin-server.cjs:738:        discount_codes (
./discount_grep.txt:689:./discount_grep.txt:261:./api/admin-server.cjs:752:    const totalDiscount = orders.reduce((sum, order) => sum + parseFloat(order.discount_amount || 0), 0);
./discount_grep.txt:690:./discount_grep.txt:262:./api/admin-server.cjs:762:    // Top discount codes used
./discount_grep.txt:691:./discount_grep.txt:263:./api/admin-server.cjs:763:    const discountUsage = orders
./discount_grep.txt:692:./discount_grep.txt:264:./api/admin-server.cjs:764:      .filter(order => order.discount_codes)
./discount_grep.txt:693:./discount_grep.txt:265:./api/admin-server.cjs:766:        const code = order.discount_codes.code;
./discount_grep.txt:694:./discount_grep.txt:266:./api/admin-server.cjs:776:        totalDiscount: totalDiscount.toFixed(2),
./discount_grep.txt:695:./discount_grep.txt:267:./api/admin-server.cjs:780:        topDiscountCodes: Object.entries(discountUsage)
./discount_grep.txt:696:./discount_grep.txt:268:./api/admin-server.cjs:827:    console.log(`   GET  /api/admin/discount-codes`);
./discount_grep.txt:697:./discount_grep.txt:269:./api/admin-server.cjs:828:    console.log(`   POST /api/admin/discount-codes`);
./discount_grep.txt:698:./discount_grep.txt:270:./api/admin-server.cjs:829:    console.log(`   PUT  /api/admin/discount-codes/:id`);
./discount_grep.txt:699:./discount_grep.txt:271:./api/admin-server.cjs:830:    console.log(`   DELETE /api/admin/discount-codes/:id`);
./discount_grep.txt:700:./discount_grep.txt:272:./api/admin-server.cjs:835:    console.log(`   SUPABASE_URL: ${supabaseUrl}`);
./discount_grep.txt:701:./discount_grep.txt:273:./api/test.js:14:      hasSupabaseUrl: !!process.env.SUPABASE_URL,
./discount_grep.txt:702:./discount_grep.txt:274:./api/test.js:15:      hasSupabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
./discount_grep.txt:703:./discount_grep.txt:275:./api/test.js:24:        hasSupabaseUrl: !!process.env.SUPABASE_URL,
./discount_grep.txt:704:./discount_grep.txt:276:./api/test.js:25:        hasSupabaseKey: !!process.env.SUPABASE_SERVICE_ROLE_KEY,
./discount_grep.txt:705:./discount_grep.txt:277:./api/orders.js:4:  process.env.SUPABASE_URL,
./discount_grep.txt:706:./discount_grep.txt:278:./api/orders.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./discount_grep.txt:707:./discount_grep.txt:279:./api/orders.js:38:      discount_code,
./discount_grep.txt:708:./discount_grep.txt:280:./api/orders.js:39:      discount_amount = 0,
./discount_grep.txt:709:./discount_grep.txt:281:./api/orders.js:52:    // Calculate original total (before discount)
./discount_grep.txt:710:./discount_grep.txt:282:./api/orders.js:53:    const original_total = discount_amount > 0 ? subtotal + shipping + tax : total;
./discount_grep.txt:711:./discount_grep.txt:283:./api/orders.js:67:        discount_code,
./discount_grep.txt:712:./discount_grep.txt:284:./api/orders.js:68:        discount_amount,
./discount_grep.txt:713:./discount_grep.txt:285:./api/admin/dashboard-stats.js:4:const supabaseUrl = process.env.VITE_SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./discount_grep.txt:714:./discount_grep.txt:286:./api/admin/dashboard-stats.js:5:const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;
./discount_grep.txt:715:./discount_grep.txt:287:./api/admin/dashboard-stats.js:6:const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZWl4b3h5eWpocnNrcmt1dXVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNzMxMzYsImV4cCI6MjA3MDk0OTEzNn0.th1_Vdi8BfeWfTDEnS3djJD8-dsEIMhLYK6-3w4w6hI';
./discount_grep.txt:716:./discount_grep.txt:288:./api/admin/dashboard-stats.js:9:  throw new Error('SUPABASE_SERVICE_ROLE_KEY environment variable is required');
./discount_grep.txt:717:./discount_grep.txt:289:./api/admin/dashboard-stats.js:66:    // Get total discount codes
./discount_grep.txt:718:./discount_grep.txt:290:./api/admin/dashboard-stats.js:68:      .from('discount_codes')
./discount_grep.txt:719:./discount_grep.txt:291:./api/admin/dashboard-stats.js:71:    // Get active discount codes
./discount_grep.txt:720:./discount_grep.txt:292:./api/admin/dashboard-stats.js:73:      .from('discount_codes')
./discount_grep.txt:721:./discount_grep.txt:293:./api/admin/dashboard-stats.js:82:      .from('discount_code_usage')
./discount_grep.txt:722:./discount_grep.txt:294:./api/admin/dashboard-stats.js:88:      .from('discount_code_usage')
./discount_grep.txt:723:./discount_grep.txt:295:./api/admin/dashboard-stats.js:89:      .select('discount_amount');
./discount_grep.txt:724:./discount_grep.txt:296:./api/admin/dashboard-stats.js:92:      sum + parseFloat(usage.discount_amount), 0) || 0;
./discount_grep.txt:725:./discount_grep.txt:297:./api/admin/orders.js:4:  process.env.SUPABASE_URL,
./discount_grep.txt:726:./discount_grep.txt:298:./api/admin/orders.js:5:  process.env.SUPABASE_SERVICE_ROLE_KEY
./discount_grep.txt:727:./discount_grep.txt:299:./api/admin/orders.js:80:          total_discounts: 0
./discount_grep.txt:728:./discount_grep.txt:300:./api/admin/orders.js:99:        discount_code,
./discount_grep.txt:729:./discount_grep.txt:301:./api/admin/orders.js:100:        discount_amount,
./discount_grep.txt:730:./discount_grep.txt:302:./api/admin/discount-codes.js:4:const supabaseUrl = process.env.SUPABASE_URL || 'https://iteixoxyyjhrskrkuuuc.supabase.co';
./discount_grep.txt:731:./discount_grep.txt:303:./api/admin/discount-co
./src/integrations/supabase/client.ts:5:const SUPABASE_URL = "https://iteixoxyyjhrskrkuuuc.supabase.co";
./src/integrations/supabase/client.ts:11:export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
./src/pages/Returns.tsx:137:                    <li>• Gift cards and promotional items</li>
./src/pages/PrivacyPolicy.tsx:109:                    <li>• Send promotional emails (with consent)</li>
./src/pages/AlphaPrintStart.tsx:91:                <li>• Bulk orders & discounts</li>
./src/pages/AlphaPrintQuote.tsx:39:    "Bulk discount",
./src/pages/AlphaPrintQuote.tsx:510:                  <span className="text-sm">Bulk discounts</span>
./src/pages/AdminDashboard.tsx:27:interface DiscountCode {
./src/pages/AdminDashboard.tsx:32:  discount_type: 'percentage' | 'fixed_amount';
./src/pages/AdminDashboard.tsx:33:  discount_value: number;
./src/pages/AdminDashboard.tsx:35:  maximum_discount_amount?: number;
./src/pages/AdminDashboard.tsx:60:  discount_code?: string;
./src/pages/AdminDashboard.tsx:61:  discount_amount?: number;
./src/pages/AdminDashboard.tsx:76:  total_discounts: number;
./src/pages/AdminDashboard.tsx:81:  const [discountCodes, setDiscountCodes] = useState<DiscountCode[]>([]);
./src/pages/AdminDashboard.tsx:91:    total_discounts: 0
./src/pages/AdminDashboard.tsx:101:  const [editingCode, setEditingCode] = useState<DiscountCode | null>(null);
./src/pages/AdminDashboard.tsx:109:    discount_type: 'percentage' as 'percentage' | 'fixed_amount',
./src/pages/AdminDashboard.tsx:110:    discount_value: '',
./src/pages/AdminDashboard.tsx:112:    maximum_discount_amount: '',
./src/pages/AdminDashboard.tsx:205:        total_discounts: 0
./src/pages/AdminDashboard.tsx:253:  const fetchDiscountCodes = async () => {
./src/pages/AdminDashboard.tsx:264:      const codesUrl = getApiUrl('/api/admin/discount-codes');
./src/pages/AdminDashboard.tsx:283:        setDiscountCodes(data.data || []);
./src/pages/AdminDashboard.tsx:285:        setError(data.error || 'Failed to fetch discount codes');
./src/pages/AdminDashboard.tsx:288:      console.error('Error fetching discount codes:', error);
./src/pages/AdminDashboard.tsx:289:      setError('Failed to fetch discount codes: ' + error.message);
./src/pages/AdminDashboard.tsx:303:        discount_value: parseFloat(newCode.discount_value),
./src/pages/AdminDashboard.tsx:305:        maximum_discount_amount: newCode.maximum_discount_amount ? parseFloat(newCode.maximum_discount_amount) : null,
./src/pages/AdminDashboard.tsx:312:      const url = getApiUrl('/api/admin/discount-codes');
./src/pages/AdminDashboard.tsx:322:        throw new Error(data.error || 'Failed to create discount code');
./src/pages/AdminDashboard.tsx:325:      setDiscountCodes(prev => [data.data, ...prev]);
./src/pages/AdminDashboard.tsx:336:  const handleUpdateCode = async (code: DiscountCode) => {
./src/pages/AdminDashboard.tsx:339:      const url = getApiUrl(`/api/admin/discount-codes/${code.id}`);
./src/pages/AdminDashboard.tsx:349:        throw new Error(data.error || 'Failed to update discount code');
./src/pages/AdminDashboard.tsx:352:      setDiscountCodes(prev => prev.map(c => c.id === code.id ? data.data : c));
./src/pages/AdminDashboard.tsx:361:    if (!confirm('Are you sure you want to delete this discount code?')) {
./src/pages/AdminDashboard.tsx:367:      const url = getApiUrl(`/api/admin/discount-codes/${codeId}`);
./src/pages/AdminDashboard.tsx:376:        throw new Error(data.error || 'Failed to delete discount code');
./src/pages/AdminDashboard.tsx:379:      setDiscountCodes(prev => prev.filter(c => c.id !== codeId));
./src/pages/AdminDashboard.tsx:391:      discount_type: 'percentage',
./src/pages/AdminDashboard.tsx:392:      discount_value: '',
./src/pages/AdminDashboard.tsx:394:      maximum_discount_amount: '',
./src/pages/AdminDashboard.tsx:420:        fetchDiscountCodes();
./src/pages/AdminDashboard.tsx:448:              <p className="text-muted-foreground">Discount Codes & Order Management</p>
./src/pages/AdminDashboard.tsx:531:        {/* Discount Codes Management */}
./src/pages/AdminDashboard.tsx:535:              <CardTitle>Discount Codes</CardTitle>
./src/pages/AdminDashboard.tsx:536:              <CardDescription>Manage your discount codes for both AlphaPrint and Silverback checkout</CardDescription>
./src/pages/AdminDashboard.tsx:547:                  <DialogTitle>Create Discount Code</DialogTitle>
./src/pages/AdminDashboard.tsx:548:                  <DialogDescription>Add a new discount code for customers</DialogDescription>
./src/pages/AdminDashboard.tsx:585:                      <Label htmlFor="discount_type">Type *</Label>
./src/pages/AdminDashboard.tsx:586:                      <Select value={newCode.discount_type} onValueChange={(value) => setNewCode(prev => ({ ...prev, discount_type: value as 'percentage' | 'fixed_amount' }))}>
./src/pages/AdminDashboard.tsx:597:                      <Label htmlFor="discount_value">Value *</Label>
./src/pages/AdminDashboard.tsx:599:                        id="discount_value"
./src/pages/AdminDashboard.tsx:602:                        value={newCode.discount_value}
./src/pages/AdminDashboard.tsx:603:                        onChange={(e) => setNewCode(prev => ({ ...prev, discount_value: e.target.value }))}
./src/pages/AdminDashboard.tsx:604:                        placeholder={newCode.discount_type === 'percentage' ? '10' : '20.00'}
./src/pages/AdminDashboard.tsx:676:              {discountCodes.map((code) => (
./src/pages/AdminDashboard.tsx:695:                      {code.discount_type === 'percentage' ? `${code.discount_value}%` : `€${code.discount_value}`} off
./src/pages/AdminDashboard.tsx:718:              {discountCodes.length === 0 && (
./src/pages/AdminDashboard.tsx:720:                  No discount codes found. Create your first discount code to get started.
./src/services/orderService.ts:27:export interface DiscountValidation {
./src/services/orderService.ts:32:  discount_type?: 'percentage' | 'fixed_amount';
./src/services/orderService.ts:33:  discount_value?: number;
./src/services/orderService.ts:34:  discount_amount?: number;
./src/services/orderService.ts:47:  discount_code?: string;
./src/services/orderService.ts:63:  discount_code?: string;
./src/services/orderService.ts:64:  discount_amount?: number;
./src/services/orderService.ts:65:  discount_type?: string;
./src/services/orderService.ts:81:  async validateDiscountCode(code: string, orderAmount: number, customerEmail?: string): Promise<DiscountValidation> {
./src/services/orderService.ts:83:      const response = await fetch(`${this.baseURL}/api/validate-discount`, {
./src/services/orderService.ts:100:          error: result.error || 'Failed to validate discount code'
./src/services/orderService.ts:106:      console.error('Discount validation error:', error);
./src/services/orderService.ts:109:        error: 'Network error while validating discount code'
./src/services/orderService.ts:118:      const total = (orderData.subtotal - (orderData.discount_code ? (orderData as any).discount_amount || 0 : 0)) + orderData.shipping + tax;
./src/services/orderService.ts:197:  // Calculate order totals with discount
./src/services/orderService.ts:198:  calculateOrderTotals(items: OrderItem[], shippingCost: number, discountValidation?: DiscountValidation) {
./src/services/orderService.ts:202:    let discountAmount = 0;
./src/services/orderService.ts:203:    if (discountValidation?.valid) {
./src/services/orderService.ts:204:      discountAmount = discountValidation.discount_amount || 0;
./src/services/orderService.ts:207:    const discountedSubtotal = Math.max(0, subtotal - discountAmount);
./src/services/orderService.ts:208:    const total = discountedSubtotal + shippingCost + tax;
./src/services/orderService.ts:212:      discountAmount,
./src/services/orderService.ts:213:      discountedSubtotal,
./src/services/stripeService.ts:4:const stripePromise = loadStripe(import.meta.env.VITE_STRIPE_PUBLISHABLE_KEY, {
./src/services/emailService.ts:4:const resend = new Resend(import.meta.env.VITE_RESEND_API_KEY);
./src/services/emailService.ts:599:                <li><strong>Member-Only Discounts:</strong> Special pricing just for subscribers</li>
